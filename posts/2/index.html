
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>LinJunzhu&#8217;s Blog</title>
	<meta name="author" content="林俊柱">

	
	<meta name="description" content="这几天遇到跨域跟同源的问题。整理下知识点。 同源策略 浏览器有一个很重要的概念——同源策略(Same-Origin Policy)。所谓同源是指，域名，协议，端口相同。不同源的客户端脚(javascript、ActionScript)本在没明确授权的情况下，不能读写对方的资源。 &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="LinJunzhu's Blog" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script async="true" src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	
</head>


<body>
	<header id="header" class="inner"><h1><a href="/">LinJunzhu&#8217;s Blog</a></h1>
<nav id="main-nav"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="https://www.google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:github.com/linjunzhu/linjunzhu.github.io.git">
			</form>
		</div>
	</div>
</nav>
<nav id="sub-nav" class="alignright">
	<div class="social">
		
		
		
		
    
		
		
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
    
	</div>
	<form class="search" action="https://www.google.com/search" method="get">
		<input class="alignright" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:github.com/linjunzhu/linjunzhu.github.io.git">
	</form>
</nav>

</header>
	
		
	
	<div id="content" class="inner">


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2015/04/21/webkua-yu-yu-tong-yuan/">
		
			WEB跨域与同源</a>
	</h2>
	<div class="entry-content">
		<p>这几天遇到<code>跨域</code>跟<code>同源</code>的问题。整理下知识点。</p>

<h1>同源策略</h1>

<p>浏览器有一个很重要的概念——同源策略(Same-Origin Policy)。所谓同源是指，域名，协议，端口相同。不同源的客户端脚(javascript、ActionScript)本在没明确授权的情况下，不能读写对方的资源。</p>

<p>如果Web世界没有同源策略，当你登录Gmail邮箱并打开另一个站点时，这个站点上的JavaScript就可以跨域读取你的Gmail邮箱数据，这样整个Web世界就无隐私可言了。</p>

<p>不同源举例：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># 同源要求同域名同协议同端口</span>
</span><span class='line'><span class="err">域名：</span>
</span><span class='line'><span class="ss">http</span><span class="p">:</span><span class="sr">//</span><span class="n">www</span><span class="o">.</span><span class="n">bigertech</span><span class="o">.</span><span class="n">com</span>
</span><span class='line'><span class="ss">http</span><span class="p">:</span><span class="sr">//</span><span class="n">bigertech</span><span class="o">.</span><span class="n">com</span>
</span><span class='line'><span class="ss">http</span><span class="p">:</span><span class="sr">//</span><span class="n">www</span><span class="o">.</span><span class="n">bigertech</span><span class="o">.</span><span class="n">cn</span>
</span><span class='line'>
</span><span class='line'><span class="err">协议：</span>
</span><span class='line'><span class="n">http</span><span class="err">、</span><span class="n">https</span>
</span><span class='line'>
</span><span class='line'><span class="err">端口</span>
</span><span class='line'><span class="mi">127</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">3000</span><span class="err">、</span> <span class="mi">127</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">3001</span>
</span></code></pre></td></tr></table></div></figure>


<p>常见的：</p>

<p>我的 A 站点，发了个 AJAX 请求到 B 站点，会收到这样的错误</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">No</span> <span class="s1">&#39;Access-Control-Allow-Origin&#39;</span> <span class="n">header</span> <span class="n">is</span> <span class="n">present</span> <span class="n">on</span> <span class="n">the</span> <span class="n">requested</span> <span class="n">resource</span>
</span></code></pre></td></tr></table></div></figure>


<h1>解决方法</h1>

<h2>1、服务器返回CORS响应头</h2>

<h3>Rails 方式</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">after_action</span> <span class="ss">:set_access_control_headers</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">set_access_control_header</span>
</span><span class='line'>  <span class="n">headers</span><span class="o">[</span><span class="s1">&#39;Access-Control-Allow-Origin&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span>
</span><span class='line'>  <span class="n">headers</span><span class="o">[</span><span class="s1">&#39;Access-Control-Request-Method&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;GET, POST, PUT, PATCH, OPTIONS, DELETE, HEAD, TRACE&quot;</span>
</span><span class='line'>  <span class="n">headers</span><span class="o">[</span><span class="s1">&#39;Access-Control-Allow-Headers&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;Origin, Access-Control-Allow-Headers, X-Requested-With, Content-Type, Accept, Connection, User-Agent, Cookie&#39;</span>
</span><span class='line'>    <span class="n">headers</span><span class="o">[</span><span class="s1">&#39;Access-Control-Allow-Credentials&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;true&#39;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>当然这里偷懒指定了所有域名都允许跨域，一般来说是指定我们允许的域名</p>

<h3>JAVA 方式</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="vi">@Override</span>
</span><span class='line'><span class="kp">public</span> <span class="n">void</span> <span class="n">doFilter</span><span class="p">(</span><span class="no">ServletRequest</span> <span class="n">servletRequest</span><span class="p">,</span> <span class="no">ServletResponse</span> <span class="n">servletResponse</span><span class="p">,</span> <span class="no">FilterChain</span> <span class="n">filterChain</span><span class="p">)</span> <span class="n">throws</span> <span class="no">IOException</span><span class="p">,</span> <span class="no">ServletException</span> <span class="p">{</span>
</span><span class='line'>  <span class="no">HttpServletResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="p">(</span><span class="no">HttpServletResponse</span><span class="p">)</span> <span class="n">servletResponse</span><span class="p">;</span>
</span><span class='line'>  <span class="nb">String</span> <span class="n">origin</span> <span class="o">=</span> <span class="p">(</span><span class="nb">String</span><span class="p">)</span> <span class="n">servletRequest</span><span class="o">.</span><span class="n">getRemoteHost</span><span class="p">()</span><span class="o">+</span><span class="s2">&quot;:&quot;</span><span class="o">+</span><span class="n">servletRequest</span><span class="o">.</span><span class="n">getRemotePort</span><span class="p">();</span>
</span><span class='line'>  <span class="n">response</span><span class="o">.</span><span class="n">setHeader</span><span class="p">(</span><span class="s2">&quot;Access-Control-Allow-Origin&quot;</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="n">response</span><span class="o">.</span><span class="n">setHeader</span><span class="p">(</span><span class="s2">&quot;Access-Control-Allow-Methods&quot;</span><span class="p">,</span> <span class="s2">&quot;GET, POST, PUT, PATCH, OPTIONS, DELETE, HEAD, TRACE&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="n">response</span><span class="o">.</span><span class="n">setHeader</span><span class="p">(</span><span class="s2">&quot;Access-Control-Max-Age&quot;</span><span class="p">,</span> <span class="s2">&quot;3600&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="n">response</span><span class="o">.</span><span class="n">setHeader</span><span class="p">(</span><span class="s2">&quot;Access-Control-Allow-Headers&quot;</span><span class="p">,</span> <span class="s2">&quot;Origin, Access-Control-Allow-Headers, X-Requested-With, Content-Type, Accept, Connection, User-Agent, Cookie&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="n">response</span><span class="o">.</span><span class="n">setHeader</span><span class="p">(</span><span class="s2">&quot;Access-Control-Allow-Credentials&quot;</span><span class="p">,</span><span class="s2">&quot;true&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="n">filterChain</span><span class="o">.</span><span class="n">doFilter</span><span class="p">(</span><span class="n">servletRequest</span><span class="p">,</span> <span class="n">servletResponse</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>当然，也可以使用 Spring 提供的 corsFilter，或使用注解等等方式</p>

<h3>说明</h3>

<h4>Access-Control-Allow-Origin</h4>

<p>它的值要么是请求时Origin字段的值，要么是一个*，表示接受任意域名的请求。</p>

<h4>Access-Control-Allow-Credentials</h4>

<p>该字段可选。它的值是一个布尔值，表示是否允许发送Cookie。默认情况下，Cookie不包括在CORS请求之中。设为true，即表示服务器明确许可，Cookie可以包含在请求中，一起发给服务器。这个值也只能设为true，如果服务器不要浏览器发送Cookie，删除该字段即可。</p>

<p>在前端 JS 也要设置该值：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">var</span> <span class="n">xhr</span> <span class="o">=</span> <span class="kp">new</span> <span class="no">XMLHttpRequest</span><span class="p">();</span>
</span><span class='line'><span class="n">xhr</span><span class="o">.</span><span class="n">withCredentials</span> <span class="o">=</span> <span class="kp">true</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>要注意的是，如果要发送Cookie，Access-Control-Allow-Origin就不能设为星号，必须指定明确的、与请求网页一致的域名。同时，Cookie依然遵循同源政策，只有用服务器域名设置的Cookie才会上传，其他域名的Cookie并不会上传，且（跨源）原网页代码中的document.cookie也无法读取服务器域名下的Cookie。</p>

<h4>Access-Control-Expose-Headers</h4>

<p>该字段可选。CORS请求时，XMLHttpRequest对象的getResponseHeader()方法只能拿到6个基本字段：Cache-Control、Content-Language、Content-Type、Expires、Last-Modified、Pragma。如果想拿到其他字段，就必须在Access-Control-Expose-Headers里面指定。上面的例子指定，getResponseHeader(&lsquo;FooBar&rsquo;)可以返回FooBar字段的值</p>

<h4>Access-Control-Allow-Methods</h4>

<p>该字段必需，它的值是逗号分隔的一个字符串，表明服务器支持的所有跨域请求的方法。注意，返回的是所有支持的方法，而不单是浏览器请求的那个方法。这是为了避免多次&#8221;预检&#8221;请求。</p>

<h4>Access-Control-Allow-Headers</h4>

<p>如果浏览器请求包括Access-Control-Request-Headers字段，则Access-Control-Allow-Headers字段是必需的。它也是一个逗号分隔的字符串，表明服务器支持的所有头信息字段，不限于浏览器在&#8221;预检&#8221;中请求的字段。</p>

<h4>Access-Control-Max-Age</h4>

<p>该字段可选，用来指定本次预检请求的有效期，单位为秒。上面结果中，有效期是20天（1728000秒），即允许缓存该条回应1728000秒（即20天），在此期间，不用发出另一条预检请求。</p>

<h3>关于 Options 请求</h3>

<p>浏览器将 CORS 请求分为两大类： 简单请求 和 非简单请求。</p>

<p>只要同时满足以下两个条件，则为简单请求。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="mi">1</span><span class="p">)</span> <span class="err">请求方法是以下三种方法之一：</span>
</span><span class='line'>
</span><span class='line'><span class="no">HEAD</span>
</span><span class='line'><span class="no">GET</span>
</span><span class='line'><span class="no">POST</span>
</span><span class='line'>
</span><span class='line'><span class="mi">2</span><span class="err">）</span><span class="no">HTTP</span><span class="err">的头信息不超出以下几种字段：</span>
</span><span class='line'>
</span><span class='line'><span class="no">Accept</span>
</span><span class='line'><span class="no">Accept</span><span class="o">-</span><span class="no">Language</span>
</span><span class='line'><span class="no">Content</span><span class="o">-</span><span class="no">Language</span>
</span><span class='line'><span class="no">Last</span><span class="o">-</span><span class="no">Event</span><span class="o">-</span><span class="no">ID</span>
</span><span class='line'><span class="no">Content</span><span class="o">-</span><span class="no">Type</span><span class="err">：只限于三个值</span><span class="n">application</span><span class="o">/</span><span class="n">x</span><span class="o">-</span><span class="n">www</span><span class="o">-</span><span class="n">form</span><span class="o">-</span><span class="n">urlencoded</span><span class="err">、</span><span class="n">multipart</span><span class="o">/</span><span class="n">form</span><span class="o">-</span><span class="n">data</span><span class="err">、</span><span class="n">text</span><span class="o">/</span><span class="n">plain</span>
</span></code></pre></td></tr></table></div></figure>


<p>如果是非简单请求，那么在请求之前，浏览器会发出一条 <code>OPTIONS</code> 预检请求，如：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">OPTIONS</span> <span class="sr">/cors HTTP/</span><span class="mi">1</span><span class="o">.</span><span class="mi">1</span>
</span><span class='line'><span class="ss">Origin</span><span class="p">:</span> <span class="ss">http</span><span class="p">:</span><span class="sr">//</span><span class="n">api</span><span class="o">.</span><span class="n">bob</span><span class="o">.</span><span class="n">com</span>
</span><span class='line'><span class="no">Access</span><span class="o">-</span><span class="no">Control</span><span class="o">-</span><span class="no">Request</span><span class="o">-</span><span class="ss">Method</span><span class="p">:</span> <span class="no">PUT</span>
</span><span class='line'><span class="no">Access</span><span class="o">-</span><span class="no">Control</span><span class="o">-</span><span class="no">Request</span><span class="o">-</span><span class="ss">Headers</span><span class="p">:</span> <span class="n">X</span><span class="o">-</span><span class="no">Custom</span><span class="o">-</span><span class="no">Header</span>
</span><span class='line'><span class="ss">Host</span><span class="p">:</span> <span class="n">api</span><span class="o">.</span><span class="n">alice</span><span class="o">.</span><span class="n">com</span>
</span><span class='line'><span class="no">Accept</span><span class="o">-</span><span class="ss">Language</span><span class="p">:</span> <span class="n">en</span><span class="o">-</span><span class="no">US</span>
</span><span class='line'><span class="ss">Connection</span><span class="p">:</span> <span class="n">keep</span><span class="o">-</span><span class="n">alive</span>
</span><span class='line'><span class="no">User</span><span class="o">-</span><span class="ss">Agent</span><span class="p">:</span> <span class="no">Mozilla</span><span class="o">/</span><span class="mi">5</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Access-Control-Request-Method</h4>

<p>该字段是必须的，用来列出浏览器的CORS请求会用到哪些HTTP方法，上例是PUT。</p>

<h4>Access-Control-Request-Headers</h4>

<p>该字段是一个逗号分隔的字符串，指定浏览器CORS请求会额外发送的头信息字段，上例是X-Custom-Header。</p>

<p>因此，服务端必须要处理 OPTIONS 请求的情况</p>

<h3>Rails</h3>

<p>1、使用  rack-cors gem</p>

<p>2、自己实现:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">before_action</span> <span class="ss">:cors_set_access_control_headers</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">cors_preflight_check</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;OPTIONS&#39;</span>
</span><span class='line'>    <span class="n">cors_set_access_control_headers</span>
</span><span class='line'>    <span class="n">render</span> <span class="ss">text</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="ss">content_type</span><span class="p">:</span> <span class="s1">&#39;text/plain&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="kp">protected</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">cors_set_access_control_headers</span>
</span><span class='line'>  <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">[</span><span class="s1">&#39;Access-Control-Allow-Origin&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span>
</span><span class='line'>  <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">[</span><span class="s1">&#39;Access-Control-Allow-Methods&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;POST, GET, PUT, PATCH, DELETE, OPTIONS&#39;</span>
</span><span class='line'>  <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">[</span><span class="s1">&#39;Access-Control-Allow-Headers&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;Origin, Content-Type, Accept, Authorization, Token, Auth-Token, Email, X-User-Token, X-User-Email&#39;</span>
</span><span class='line'>  <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">[</span><span class="s1">&#39;Access-Control-Max-Age&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;1728000&#39;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">#routes</span>
</span><span class='line'><span class="n">match</span> <span class="s1">&#39;*all&#39;</span><span class="p">,</span> <span class="ss">controller</span><span class="p">:</span> <span class="s1">&#39;application&#39;</span><span class="p">,</span> <span class="ss">action</span><span class="p">:</span> <span class="s1">&#39;cors_preflight_check&#39;</span><span class="p">,</span> <span class="ss">via</span><span class="p">:</span> <span class="o">[</span><span class="ss">:options</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Java</h3>

<ol>
<li>默认在 Spring3.x 起，就会自动处理 Options 的请求了，所以可以不用做什么操作。</li>
<li>在一些旧版本，可以考虑在 filter 监测 options 请求，返回 true</li>
</ol>


<h2>2、使用<code>JSONP</code>方式</h2>

<p>JSONP(JSON with Padding)是一个非官方的协议，它允许在服务器端集成Script tags返回至客户端，通过javascript callback的形式实现跨域访问（这仅仅是JSONP简单的实现形式）</p>

<p>虽然浏览器有<code>同源策略</code>，但是<code>HTML</code>中的<code>img,script</code>等标签是不用遵循同源策略的， JSONP 则是利用了 script 这个特点。</p>

<p>服务端：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># callback 是 rails 直接支持 JSONP 的参数</span>
</span><span class='line'><span class="c1"># hello 一般是客户端给过来的 callback 函数名</span>
</span><span class='line'><span class="c1"># `callback函数` 将在客户端进行执行 script</span>
</span><span class='line'><span class="k">def</span> <span class="nf">index</span>
</span><span class='line'>   <span class="n">render</span> <span class="ss">json</span><span class="p">:</span> <span class="p">{</span><span class="ss">hello</span><span class="p">:</span> <span class="ss">:world</span><span class="p">},</span> <span class="ss">callback</span><span class="p">:</span> <span class="n">hello</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 关闭 csrf 防护</span>
</span><span class='line'><span class="c1"># 因为返回格式为 xxx()，属于危险字符script</span>
</span><span class='line'><span class="c1"># protect_from_forgery with: :exception</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 返回结果</span>
</span><span class='line'><span class="sr">/**/</span><span class="n">hello</span><span class="p">({</span><span class="s2">&quot;hello&quot;</span><span class="ss">:&quot;world&quot;</span><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<p>客户端：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># 方式1</span>
</span><span class='line'><span class="o">&lt;</span><span class="n">script</span> <span class="n">src</span><span class="o">=</span><span class="s2">&quot;localhost:3001/students&quot;</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 方式2 ( 使用 jquery )</span>
</span><span class='line'><span class="n">function</span> <span class="n">hello</span><span class="p">(){</span>
</span><span class='line'>  <span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;something&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="vg">$.</span><span class="n">ajax</span><span class="p">({</span>
</span><span class='line'>    <span class="ss">type</span><span class="p">:</span> <span class="s1">&#39;GET&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">jsonp</span><span class="p">:</span> <span class="s1">&#39;callback函数名&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">dataType</span><span class="p">:</span> <span class="s2">&quot;jsonp&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">url</span><span class="p">:</span> <span class="s2">&quot;http://localhost:3001/students&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">success</span><span class="p">:</span> <span class="n">function</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>       <span class="c1"># 一旦返回将会自动执行hello()</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="ss">error</span><span class="p">:</span> <span class="n">function</span><span class="p">(</span><span class="no">XMLHttpRequest</span><span class="p">,</span> <span class="n">textStatus</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<h1>Tips</h1>

<p>虽然说有<code>同源策略</code>的存在，站点 A 拿不到站点 B 的信息。但其实站点 B 已经处理完请求 response 回去了，只不过被站点 A 的浏览器给拦截了。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># 站点 B，此时已经成功处理请求返回 response 了</span>
</span><span class='line'><span class="no">Started</span> <span class="no">GET</span> <span class="s2">&quot;/students&quot;</span> <span class="k">for</span> <span class="o">::</span><span class="mi">1</span> <span class="n">at</span> <span class="mi">2015</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">21</span> <span class="mi">20</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mi">32</span> <span class="o">+</span><span class="mi">0800</span>
</span><span class='line'><span class="no">Processing</span> <span class="n">by</span> <span class="no">StudentsController</span><span class="c1">#index as */*</span>
</span><span class='line'><span class="no">Completed</span> <span class="mi">200</span> <span class="no">OK</span> <span class="k">in</span> <span class="mi">1</span><span class="n">ms</span> <span class="p">(</span><span class="ss">Views</span><span class="p">:</span> <span class="mi">0</span><span class="o">.</span><span class="mi">1</span><span class="n">ms</span> <span class="o">|</span> <span class="ss">ActiveRecord</span><span class="p">:</span> <span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="n">ms</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>因此，如果你在后台代码中 / Shell 中进行访问请求的话：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># 是成功返回信息的</span>
</span><span class='line'><span class="err">$</span> <span class="n">curl</span> <span class="ss">http</span><span class="p">:</span><span class="sr">//</span><span class="ss">localhost</span><span class="p">:</span><span class="mi">3001</span><span class="o">/</span><span class="n">students</span>
</span><span class='line'>
</span><span class='line'><span class="o">=&gt;</span>   <span class="sr">/**/</span><span class="n">hello</span><span class="p">({</span><span class="s2">&quot;hello&quot;</span><span class="ss">:&quot;world&quot;</span><span class="p">})</span><span class="o">%</span>
</span></code></pre></td></tr></table></div></figure>


<p>有人说这样子那同源策略有什么用？不是一下子就被破解了么？</p>

<p>首先，<code>同源策略</code>是浏览器的行为。</p>

<p>其次，当你登录了网银后，打开<code>站点A</code>，此时<code>站点A</code>向<code>网银</code>发送一条<code>request</code>，注意，此时是会附带你<code>网银cookies</code>过去的，相当于你在<code>网银</code>自己发的<code>request</code>一样，如果没有<code>同源策略</code>，这时你的<code>网银</code>就相当于别人的了。。。（当然网银的安全程度远远大于此- -)</p>

<p>而如果你用后台进行发送请求的话，是不会附带任何<code>cookies</code>的。因此也就无效了。</p>

<p>注意 <code>postman</code>是可以成功请求的。（不知道postman做了什么，总之postman没有阻止跨域的情况)</p>

<h2>XSS 与 CSRF</h2>

<p>说起安全，这两者可是 WEB 届大名鼎鼎的漏洞明星啊！</p>

<p>XSS :  跨站脚本攻击</p>

<p>CSRF : 跨站请求伪造攻击。</p>

<p>以下這篇文章写得非常好，值得一看。
<a href="http://snoopyxdy.blog.163.com/blog/static/60117440201281294147873/">http://snoopyxdy.blog.163.com/blog/static/60117440201281294147873/</a></p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2015-04-21T20:08:09+08:00" pubdate data-updated="true"></time></div>
	<div class="tags">

</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2015/04/20/rails-csrf-explore/">
		
			Rails-CSRF-Explore</a>
	</h2>
	<div class="entry-content">
		<h2>目录</h2>

<ol>
<li>引言</li>
<li>session</li>
<li>CSRF</li>
<li>真相大白</li>
<li>破解？</li>
</ol>


<h2>一、引言</h2>

<p>这段时间一直在想，Rails 的 CSRF token 要破解不是很简单么？<code>GET</code>请求到网页拿到 token，随后发送恶意<code>POST</code>请求到服务器不就破解了么？事实证明我还是 Too young too simple.</p>

<h2>二、尝试</h2>

<ol>
<li><p>写了个程序在<code>ruby</code>中去<code>GET</code>其他服务器的网页，获取到<code>token</code>后，伪造恶意<code>POST</code>请求，附带<code>token</code>，结果<code>402 invalid token</code></p></li>
<li><p>真实打开浏览器，获取网页中<code>token</code>，随后复制该<code>token</code>，在<code>ruby</code>中恶意伪造<code>POST</code>请求并附带<code>token</code>，结果还是<code>402 invalid token</code></p></li>
<li><p>真实打开浏览器，获取token，打开<code>postman</code>，发送<code>POST</code>请求。成功<code>200</code></p></li>
</ol>


<p>这是为什么呢？</p>

<h2>二、session</h2>

<p>在 Rails 中，默认的session存储方式是：<code>ActionDispatch::Session::CookieStore</code></p>

<p>也就是默认将<code>session</code>的内容存放到客户端<code>cookie</code>中。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="ss">_glassx_session</span><span class="p">:</span>
</span><span class='line'><span class="no">TE9xZ3Zud1dxRFYxdEtSek5mYldTMkpnZ1NWUlF5SjdzODVRSkJYNGN6VmNDc1VGb1lzSGJPU0FLYWhoMU5ZSHZCeXUwNTFWdWFQaWpKZmZSUC96c0dWbFdDcmlZK3RTcENabXZoaFVScWx1SWlxR1dEbmcwU1BXSDBZWUVOVW1EN0ZscmZpWkJsOFBZajZST0Z3VWxJM09NOGVTRFp2djRyYVB4SVJZNkVWRlM4dmw0TVNYb01jOGJYdVRXKzYxY1pyeXNtT0VkVWZ4YjZFcTdVU1FLVEU2aXlXbGRIOWY3c0Q1THlPRGtWeFhOb1BCd1M0S3hOQ04xTHNSajh3MC0tS3I0UVZkK2tuWGx0d1BDSVp3b1diZz09</span><span class="o">--</span><span class="n">cd6094c15ae50026d0377b6c32b7e0986b447d74</span>
</span></code></pre></td></tr></table></div></figure>


<p>session中的数据保存在cookie中时是先marshal后，然后利用密码来加密的。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">marshal</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">---</span><span class="n">digest_with_secret_key</span><span class="p">(</span><span class="n">marshal</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>这里所用<code>secret key</code>则是我们在<code>config/secrets.yml</code>设置的。</p>

<p>加密的原因是防止 session 被偷看，并且<code>防止 session 被修改</code>。</p>

<h2>三、CSRF</h2>

<p>我们在访问服务器的网页时，会找到这样的 token</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;</span><span class="n">meta</span> <span class="nb">name</span><span class="o">=</span><span class="s2">&quot;csrf-param&quot;</span> <span class="n">content</span><span class="o">=</span><span class="s2">&quot;authenticity_token&quot;</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="n">meta</span> <span class="nb">name</span><span class="o">=</span><span class="s2">&quot;csrf-token&quot;</span> <span class="n">content</span><span class="o">=</span><span class="s2">&quot;yT5/q+GxMDy96ISmdNfE4esNrc8YZOBUrQefXO21tJ19iGD1XjRkJ2/ELC1A952U5qDp3vpo6MhhHQB8fOmivw==&quot;</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>这<code>token</code>是服务器生成后返回的。</p>

<p>具体流程是：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># 生成加密的token（也就是我们在网页上见到的csrf-token)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">masked_authenticity_token</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
</span><span class='line'>  <span class="n">one_time_pad</span> <span class="o">=</span> <span class="no">SecureRandom</span><span class="o">.</span><span class="n">random_bytes</span><span class="p">(</span><span class="no">AUTHENTICITY_TOKEN_LENGTH</span><span class="p">)</span>
</span><span class='line'>  <span class="n">encrypted_csrf_token</span> <span class="o">=</span> <span class="n">xor_byte_strings</span><span class="p">(</span><span class="n">one_time_pad</span><span class="p">,</span> <span class="n">real_csrf_token</span><span class="p">(</span><span class="n">session</span><span class="p">))</span>
</span><span class='line'>  <span class="n">masked_token</span> <span class="o">=</span> <span class="n">one_time_pad</span> <span class="o">+</span> <span class="n">encrypted_csrf_token</span>
</span><span class='line'>  <span class="no">Base64</span><span class="o">.</span><span class="n">strict_encode64</span><span class="p">(</span><span class="n">masked_token</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 生成 _csrf_token，并且将其放入`session[:_csrf_token]`中</span>
</span><span class='line'><span class="k">def</span> <span class="nf">real_csrf_token</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
</span><span class='line'>  <span class="n">session</span><span class="o">[</span><span class="ss">:_csrf_token</span><span class="o">]</span> <span class="o">||=</span> <span class="no">SecureRandom</span><span class="o">.</span><span class="n">base64</span><span class="p">(</span><span class="no">AUTHENTICITY_TOKEN_LENGTH</span><span class="p">)</span>
</span><span class='line'>  <span class="no">Base64</span><span class="o">.</span><span class="n">strict_decode64</span><span class="p">(</span><span class="n">session</span><span class="o">[</span><span class="ss">:_csrf_token</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 验证 token 是否有效（这段代码我简化过）</span>
</span><span class='line'><span class="k">def</span> <span class="nf">valid_authenticity_token?</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">encoded_masked_token</span><span class="p">)</span>
</span><span class='line'>  <span class="n">masked_token</span> <span class="o">=</span> <span class="no">Base64</span><span class="o">.</span><span class="n">strict_decode64</span><span class="p">(</span><span class="n">encoded_masked_token</span><span class="p">)</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">masked_token</span><span class="o">.</span><span class="n">length</span> <span class="o">==</span> <span class="no">AUTHENTICITY_TOKEN_LENGTH</span>
</span><span class='line'>       <span class="n">compare_with_real_token</span> <span class="n">masked_token</span><span class="p">,</span> <span class="n">session</span>
</span><span class='line'>  <span class="k">elsif</span> <span class="n">masked_token</span><span class="o">.</span><span class="n">length</span> <span class="o">==</span> <span class="no">AUTHENTICITY_TOKEN_LENGTH</span> <span class="o">*</span> <span class="mi">2</span>
</span><span class='line'>     <span class="n">one_time_pad</span> <span class="o">=</span> <span class="n">masked_token</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">AUTHENTICITY_TOKEN_LENGTH</span><span class="o">]</span>
</span><span class='line'>       <span class="n">encrypted_csrf_token</span> <span class="o">=</span> <span class="n">masked_token</span><span class="o">[</span><span class="no">AUTHENTICITY_TOKEN_LENGTH</span><span class="o">.</span><span class="n">.</span><span class="o">-</span><span class="mi">1</span><span class="o">]</span>
</span><span class='line'>       <span class="n">csrf_token</span> <span class="o">=</span> <span class="n">xor_byte_strings</span><span class="p">(</span><span class="n">one_time_pad</span><span class="p">,</span> <span class="n">encrypted_csrf_token</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>       <span class="n">compare_with_real_token</span> <span class="n">csrf_token</span><span class="p">,</span> <span class="n">session</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 开始验证</span>
</span><span class='line'><span class="k">def</span> <span class="nf">compare_with_real_token</span><span class="p">(</span><span class="n">unmasked_token</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>
</span><span class='line'>   <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">SecurityUtils</span><span class="o">.</span><span class="n">secure_compare</span><span class="p">(</span><span class="n">unmasked_token</span><span class="p">,</span> <span class="n">real_csrf_token</span><span class="p">(</span><span class="n">session</span><span class="p">))</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>从源码可以看出，服务器会将生成的<code>_csrf_token</code>放入用户的<code>session</code>中，当客户端将<code>csrf_token</code>随着<code>request</code>发送过来时，服务器会将<code>csrf_token</code>转换回非加密，随后与<code>session</code>中的<code>_csrf_token</code>进行验证。</p>

<h2>四、真相大白</h2>

<ol>
<li>验证时需要<code>session内的_csrf_token</code>，而用<code>ruby</code>代码直接发送http请求时是不会附带<code>cookies</code>的，所以验证肯定不会通过，这也是上面尝试第一二步失败的原因。</li>
<li>使用<code>postman</code>是会自带<code>cookies</code>发送过去的，因此验证通过。</li>
</ol>


<h3>Tips</h3>

<p>附带<code>cookies</code>是浏览器的行为</p>

<h2>五、破解？</h2>

<p>这时有人会问，<code>rails</code>是开源的，有人看了源码之后，拿到网页的<code>csrf_token</code>，按照步骤一步步转换回非加密状态，不就破解了？</p>

<p>还是 too young!</p>

<p>在服务器是将<code>session[_csrf_token]</code>跟用户的<code>csrf_token</code>进行验证，就算你将<code>csrf_token</code>还原了也没用，还是需要<code>session[_csrf_token]</code>，而<code>session</code>是经过<code>secret</code>加密过的，因为无法篡改<code>session</code>，因而也破解不了。</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2015-04-20T22:52:59+08:00" pubdate data-updated="true"></time></div>
	<div class="tags">

</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2015/03/06/shi-yong-rubysheng-cheng-er-wei-ma/">
		
			使用Ruby生成二维码</a>
	</h2>
	<div class="entry-content">
		<h2>前言</h2>

<p>偶尔项目中会用到二维码，这时生成二维码有几种方式：</p>

<ol>
<li>自己动手，丰衣足食，自己来生成</li>
<li>通过调用网络API来拉取二维码</li>
</ol>


<p>但是，由于担心网络的不稳定 或者 项目只能对内部开放，此时就需要第一种方式来实现了。</p>

<h2>所需 Gem</h2>

<ol>
<li>gem &lsquo;qrencoder&rsquo;</li>
<li>gem &lsquo;rqrencoder-magick&rsquo;</li>
<li>gem &lsquo;rqrcode_png&rsquo;</li>
</ol>


<h2>Begin</h2>

<h3>1. 先安装本机库 <code>qrencode</code></h3>

<p>Mac 用户：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>brew install qrencode</span></code></pre></td></tr></table></div></figure>


<p>Linux 用户：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>apt-get install qrencode</span></code></pre></td></tr></table></div></figure>


<h3>2. 安装 <code>qrencoder</code> 这个 gem</h3>

<p>项目主页： <a href="https://github.com/harrisj/qrencoder">https://github.com/harrisj/qrencoder</a></p>

<p>安装之前需要先安装依赖库，否则会安装不上：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>apt-get install libqrencode-dev python-qrencode qrencode
</span></code></pre></td></tr></table></div></figure>


<p>安装时需要指定路径：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>gem install qrencoder –with-opt-include<span class="o">=</span>/usr/local/include –with-opt-lib<span class="o">=</span>/usr/local/lib
</span></code></pre></td></tr></table></div></figure>


<p><code>gem qrencoder</code></p>

<h3>3. 安装 <code>rqrencoder-magick</code> 和 <code>rqrencoder</code></h3>

<p>前者是利用了<code>RMagick</code>来生成二维码，因此需要事先安装 <code>RMagick</code>，安装方法就不说了。</p>

<p>在 <code>gemfile</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>gem <span class="s1">&#39;rqrencoder-magick&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>在<code>shell</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>gem install rqrencoder –with-opt-include<span class="o">=</span>/usr/local/include –with-opt-lib<span class="o">=</span>/usr/local/lib
</span></code></pre></td></tr></table></div></figure>


<h3>4. 安装<code>rqrcode_png</code></h3>

<p><code>gem rqrcode_png</code></p>

<p>这个 Gem 可以为生成的二维码指定<code>宽度</code>和<code>高度</code></p>

<h3>5. <code>DEMO</code></h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># 生成二维码</span>
</span><span class='line'><span class="nv">qr</span> <span class="o">=</span> RQRCode::QRCode.new<span class="o">(</span> self.code, :size <span class="o">=</span>&gt; 1, :level <span class="o">=</span>&gt; :l <span class="o">)</span>
</span><span class='line'><span class="nv">png</span> <span class="o">=</span> qr.to_img
</span><span class='line'>png.resize<span class="o">(</span>300, 300<span class="o">)</span>.save<span class="o">(</span>path<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<h3>6. 不足</h3>

<p>这种方式生成的二维码图片会比现今网上提供的api所生成的二维码要「难扫」「复杂」，所以如果对二维码的扫描难度有要求的话，就&hellip;.</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2015-03-06T15:53:15+08:00" pubdate data-updated="true"></time></div>
	<div class="tags">

</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2015/01/30/shi-yong-mosquitto/">
		
			使用 Mosquitto</a>
	</h2>
	<div class="entry-content">
		<h2>引言</h2>

<p>这段时间团队需要跟 Google Glass 进行交互，因此要做一个推送机制。而 MQTT 协议的推送是当今最火热的一个。</p>

<p>Mosquitto 则是实现了 MQTT 协议的服务。</p>

<h2>安装</h2>

<p>在 Ubuntu 下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">add</span><span class="o">-</span><span class="n">repository</span> <span class="ss">ppa</span><span class="p">:</span><span class="n">mosquitto</span><span class="o">-</span><span class="n">dev</span><span class="o">/</span><span class="n">mosquitto</span><span class="o">-</span><span class="n">ppa</span>
</span><span class='line'><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">update</span>
</span></code></pre></td></tr></table></div></figure>


<p>如果显示<code>apt-add-repository</code>没有识别，则可以：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">python</span><span class="o">-</span><span class="n">software</span><span class="o">-</span><span class="n">properties</span>
</span></code></pre></td></tr></table></div></figure>


<h2>配置</h2>

<p>安装完成后，所有配置都会在 <code>/etc/mosquitto</code>目录下。其中最重要的则是<code>mosquitto.conf</code> 文件，以下则是配置文件内容。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># =================================================================</span>
</span><span class='line'><span class="c1"># General configuration</span>
</span><span class='line'><span class="c1"># =================================================================</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 客户端心跳的间隔时间</span>
</span><span class='line'><span class="c1">#retry_interval 20</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 系统状态的刷新时间</span>
</span><span class='line'><span class="c1">#sys_interval 10</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 系统资源的回收时间，0表示尽快处理</span>
</span><span class='line'><span class="c1">#store_clean_interval 10</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 服务进程的PID</span>
</span><span class='line'><span class="c1">#pid_file /var/run/mosquitto.pid</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 服务进程的系统用户</span>
</span><span class='line'><span class="c1">#user mosquitto</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 客户端心跳消息的最大并发数</span>
</span><span class='line'><span class="c1">#max_inflight_messages 10</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 客户端心跳消息缓存队列</span>
</span><span class='line'><span class="c1">#max_queued_messages 100</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 用于设置客户端长连接的过期时间，默认永不过期</span>
</span><span class='line'><span class="c1">#persistent_client_expiration</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># =================================================================</span>
</span><span class='line'><span class="c1"># Default listener</span>
</span><span class='line'><span class="c1"># =================================================================</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 服务绑定的IP地址</span>
</span><span class='line'><span class="c1">#bind_address</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 服务绑定的端口号</span>
</span><span class='line'><span class="c1">#port 1883</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 允许的最大连接数，-1表示没有限制</span>
</span><span class='line'><span class="c1">#max_connections -1</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># cafile：CA证书文件</span>
</span><span class='line'><span class="c1"># capath：CA证书目录</span>
</span><span class='line'><span class="c1"># certfile：PEM证书文件</span>
</span><span class='line'><span class="c1"># keyfile：PEM密钥文件</span>
</span><span class='line'><span class="c1">#cafile</span>
</span><span class='line'><span class="c1">#capath</span>
</span><span class='line'><span class="c1">#certfile</span>
</span><span class='line'><span class="c1">#keyfile</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 必须提供证书以保证数据安全性</span>
</span><span class='line'><span class="c1">#require_certificate false</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 若require_certificate值为true，use_identity_as_username也必须为true</span>
</span><span class='line'><span class="c1">#use_identity_as_username false</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 启用PSK（Pre-shared-key）支持</span>
</span><span class='line'><span class="c1">#psk_hint</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># SSL/TSL加密算法，可以使用“openssl ciphers”命令获取</span>
</span><span class='line'><span class="c1"># as the output of that command.</span>
</span><span class='line'><span class="c1">#ciphers</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># =================================================================</span>
</span><span class='line'><span class="c1"># Persistence</span>
</span><span class='line'><span class="c1"># =================================================================</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 消息自动保存的间隔时间</span>
</span><span class='line'><span class="c1">#autosave_interval 1800</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 消息自动保存功能的开关</span>
</span><span class='line'><span class="c1">#autosave_on_changes false</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 持久化功能的开关</span>
</span><span class='line'><span class="n">persistence</span> <span class="kp">true</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 持久化DB文件</span>
</span><span class='line'><span class="c1">#persistence_file mosquitto.db</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 持久化DB文件目录</span>
</span><span class='line'><span class="c1">#persistence_location /var/lib/mosquitto/</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># =================================================================</span>
</span><span class='line'><span class="c1"># Logging</span>
</span><span class='line'><span class="c1"># =================================================================</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 4种日志模式：stdout、stderr、syslog、topic</span>
</span><span class='line'><span class="c1"># none 则表示不记日志，此配置可以提升些许性能</span>
</span><span class='line'><span class="n">log_dest</span> <span class="n">none</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#还有一种写入文件的模式</span>
</span><span class='line'><span class="n">log_dest</span> <span class="n">file</span> <span class="s1">&#39;/var/lib/mosquitto/mosquitto.log&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 选择日志的级别（可设置多项）</span>
</span><span class='line'><span class="c1">#log_type error</span>
</span><span class='line'><span class="c1">#log_type warning</span>
</span><span class='line'><span class="c1">#log_type notice</span>
</span><span class='line'><span class="c1">#log_type information</span>
</span><span class='line'><span class="c1">#log_type all</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 是否记录客户端连接信息</span>
</span><span class='line'><span class="c1">#connection_messages true</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 是否记录日志时间</span>
</span><span class='line'><span class="c1">#log_timestamp true</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># =================================================================</span>
</span><span class='line'><span class="c1"># Security</span>
</span><span class='line'><span class="c1"># =================================================================</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 客户端ID的前缀限制，可用于保证安全性</span>
</span><span class='line'><span class="c1">#clientid_prefixes</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 允许匿名用户</span>
</span><span class='line'><span class="c1">#allow_anonymous true</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 用户/密码文件，默认格式：username:password</span>
</span><span class='line'><span class="c1">#password_file</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># PSK格式密码文件，默认格式：identity:key</span>
</span><span class='line'><span class="c1">#psk_file</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># pattern write sensor/%u/data</span>
</span><span class='line'><span class="c1"># ACL权限配置，常用语法如下：</span>
</span><span class='line'><span class="c1"># 用户限制：user &lt;username&gt;</span>
</span><span class='line'><span class="c1"># 话题限制：topic [read|write] &lt;topic&gt;</span>
</span><span class='line'><span class="c1"># 正则限制：pattern write sensor/%u/data</span>
</span><span class='line'><span class="c1">#acl_file</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># =================================================================</span>
</span><span class='line'><span class="c1"># Bridges</span>
</span><span class='line'><span class="c1"># =================================================================</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 允许服务之间使用“桥接”模式（可用于分布式部署）</span>
</span><span class='line'><span class="c1">#connection &lt;name&gt;</span>
</span><span class='line'><span class="c1">#address &lt;host&gt;[:&lt;port&gt;]</span>
</span><span class='line'><span class="c1">#topic &lt;topic&gt; [[[out | in | both] qos-level] local-prefix remote-prefix]</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 设置桥接的客户端ID</span>
</span><span class='line'><span class="c1">#clientid</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 桥接断开时，是否清除远程服务器中的消息</span>
</span><span class='line'><span class="c1">#cleansession false</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 是否发布桥接的状态信息</span>
</span><span class='line'><span class="c1">#notifications true</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 设置桥接模式下，消息将会发布到的话题地址</span>
</span><span class='line'><span class="c1"># $SYS/broker/connection/&lt;clientid&gt;/state</span>
</span><span class='line'><span class="c1">#notification_topic</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 设置桥接的keepalive数值</span>
</span><span class='line'><span class="c1">#keepalive_interval 60</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 桥接模式，目前有三种：automatic、lazy、once</span>
</span><span class='line'><span class="c1">#start_type automatic</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 桥接模式automatic的超时时间</span>
</span><span class='line'><span class="c1">#restart_timeout 30</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 桥接模式lazy的超时时间</span>
</span><span class='line'><span class="c1">#idle_timeout 60</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 桥接客户端的用户名</span>
</span><span class='line'><span class="c1">#username</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 桥接客户端的密码</span>
</span><span class='line'><span class="c1">#password</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># bridge_cafile：桥接客户端的CA证书文件</span>
</span><span class='line'><span class="c1"># bridge_capath：桥接客户端的CA证书目录</span>
</span><span class='line'><span class="c1"># bridge_certfile：桥接客户端的PEM证书文件</span>
</span><span class='line'><span class="c1"># bridge_keyfile：桥接客户端的PEM密钥文件</span>
</span><span class='line'><span class="c1">#bridge_cafile</span>
</span><span class='line'><span class="c1">#bridge_capath</span>
</span><span class='line'><span class="c1">#bridge_certfile</span>
</span><span class='line'><span class="c1">#bridge_keyfile</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 自己的配置可以放到以下目录中</span>
</span><span class='line'><span class="n">include_dir</span> <span class="sr">/etc/mos</span><span class="n">quitto</span><span class="o">/</span><span class="n">conf</span><span class="o">.</span><span class="n">d</span>
</span></code></pre></td></tr></table></div></figure>


<h2>权限</h2>

<p>为了避免任何人都可以往服务器去 pull&amp;push，我们需要设置权限。</p>

<p>使用自带工具进行设置账号：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#add a count and then will ask you to enter a passwd</span>
</span><span class='line'><span class="n">mosquitto_passwd</span> <span class="o">-</span><span class="n">c</span> <span class="sr">/etc/mos</span><span class="n">quitto</span><span class="o">/</span><span class="n">passwd</span> <span class="n">glassx</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># delete</span>
</span><span class='line'><span class="n">mosquitto_passwd</span> <span class="o">-</span><span class="n">D</span> <span class="sr">/etc/mos</span><span class="n">quitto</span><span class="o">/</span><span class="n">passwd</span> <span class="n">glassx</span>
</span></code></pre></td></tr></table></div></figure>


<h2>启动</h2>

<p>启动服务很简单，直接运行：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">mosquitto</span> <span class="o">-</span><span class="n">c</span> <span class="sr">/etc/mos</span><span class="n">quitto</span><span class="o">/</span><span class="n">mosquitto</span><span class="o">.</span><span class="n">conf</span> <span class="o">-</span><span class="n">d</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#-c 表示加载指定配置文件</span>
</span><span class='line'><span class="c1">#-d 表示以后台服务运行</span>
</span><span class='line'><span class="c1">#-p 表示监听某个端口（默认为1883)</span>
</span><span class='line'><span class="c1">#-v 表示亢长的日志记录模式，相当于设置 log_type all</span>
</span></code></pre></td></tr></table></div></figure>


<p>mosquitto 是个异步 IO 框架，经过测试可以处理 20000 个以上的客户端连接。</p>

<h2>推送</h2>

<p>上面所创建的只是服务器， MQTT 有三个角色， 发布角色，服务器角色，消费角色。 此时我们便使用 Ruby 来实现发布角色。</p>

<p>我们会使用到一个叫做 <code>mqtt</code> 的 gem</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;rubygems&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;mqtt&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Publish example</span>
</span><span class='line'><span class="no">MQTT</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;mqtt://glassx:glassxpw@127.0.0.1&#39;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">c</span><span class="o">|</span>
</span><span class='line'>  <span class="nb">p</span> <span class="n">c</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="s1">&#39;topic&#39;</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># # Subscribe example</span>
</span><span class='line'><span class="c1"># MQTT::Client.connect(&#39;test.mosquitto.org&#39;) do |c|</span>
</span><span class='line'><span class="c1">#   # If you pass a block to the get method, then it will loop</span>
</span><span class='line'><span class="c1">#   c.get(&#39;test&#39;) do |topic,message|</span>
</span><span class='line'><span class="c1">#     puts &quot;#{topic}: #{message}&quot;</span>
</span><span class='line'><span class="c1">#   end</span>
</span><span class='line'><span class="c1"># end</span>
</span></code></pre></td></tr></table></div></figure>


<h2>接收</h2>

<p>接收则是各个客户端的实现了，这里就不写了。</p>

<h2>引用</h2>

<p>官网：<a href="http://mosquitto.org/">http://mosquitto.org/</a></p>

<p>简要教程：<a href="http://blog.csdn.net/shagoo/article/details/7910598">http://blog.csdn.net/shagoo/article/details/7910598</a></p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2015-01-30T16:04:40+08:00" pubdate data-updated="true"></time></div>
	<div class="tags">

</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2015/01/30/bu-shu-rabbitmq-jing-yan/">
		
			部署 RabbitMQ 经验</a>
	</h2>
	<div class="entry-content">
		<h2>引用</h2>

<p>在项目中，将一些无需即时返回且耗时的操作提取出来，放入消息队列，进行异步处理，而这种异步处理的方式大大的节省了服务器的请求响应时间，从而提高了系统的吞吐量。</p>

<p>RabbitMQ 是一个在 AMQP 基础上完整的，可复用的企业消息系统。他遵循Mozilla Public License开源协议。</p>

<h2>安装</h2>

<p>Ubuntu 下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">deb</span> <span class="ss">http</span><span class="p">:</span><span class="sr">//</span><span class="n">www</span><span class="o">.</span><span class="n">rabbitmq</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">debian</span><span class="o">/</span> <span class="n">testing</span> <span class="n">main</span>
</span><span class='line'>
</span><span class='line'><span class="n">wget</span> <span class="ss">http</span><span class="p">:</span><span class="sr">//</span><span class="n">www</span><span class="o">.</span><span class="n">rabbitmq</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">rabbitmq</span><span class="o">-</span><span class="n">signing</span><span class="o">-</span><span class="n">key</span><span class="o">-</span><span class="kp">public</span><span class="o">.</span><span class="n">asc</span>
</span><span class='line'><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">key</span> <span class="n">add</span> <span class="n">rabbitmq</span><span class="o">-</span><span class="n">signing</span><span class="o">-</span><span class="n">key</span><span class="o">-</span><span class="kp">public</span><span class="o">.</span><span class="n">asc</span>
</span><span class='line'>
</span><span class='line'><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">rabbitmq</span><span class="o">-</span><span class="n">server</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#/etc/default/rabbitmq-server</span>
</span><span class='line'><span class="n">ulimit</span> <span class="o">-</span><span class="n">n</span> <span class="mi">1024</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># 开启服务</span>
</span><span class='line'><span class="n">invoke</span><span class="o">-</span><span class="n">rc</span><span class="o">.</span><span class="n">d</span> <span class="n">rabbitmq</span><span class="o">-</span><span class="n">server</span> <span class="n">stop</span><span class="o">/</span><span class="n">start</span><span class="o">/</span><span class="n">etc</span><span class="o">.</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 开启 WEB 管理</span>
</span><span class='line'><span class="n">rabbitmq</span><span class="o">-</span><span class="n">plugins</span> <span class="n">enable</span> <span class="n">rabbitmq_management</span>
</span></code></pre></td></tr></table></div></figure>


<h2>注意事项</h2>

<ol>
<li>要自己添加 /etc/rabbitmq/rabbitmq.config 才行</li>
<li>默认只有本机才能用 guest/guest 账号登陆。否则需要在rabbitmq.config 添加<code>[{rabbit, [{loopback_users, []}]}].</code></li>
<li>rabbitq.config 的格式是：</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># 就算删除了里面的参数配置，也不能删除这个格式。</span>
</span><span class='line'><span class="o">[</span>
</span><span class='line'><span class="o">].</span>
</span></code></pre></td></tr></table></div></figure>


<h2>可能出现的错误</h2>

<ol>
<li>总是提示</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="ss">ls</span><span class="p">:</span> <span class="n">cannot</span> <span class="n">access</span> <span class="sr">/etc/</span><span class="n">rabbitmq</span><span class="o">/</span><span class="n">rabbitmq</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">d</span><span class="p">:</span> <span class="no">No</span> <span class="n">such</span> <span class="n">file</span> <span class="ow">or</span> <span class="n">directory</span>
</span></code></pre></td></tr></table></div></figure>


<p>原因： 妈蛋是缺了目录啊！手动创建就可以了，之前一直以为是缺了文件，原来是目录，注意了 <code>conf.d</code> <code>.d</code> 这个结尾的一般都是目录</p>

<h2>懒</h2>

<p>具体就不写了，不过有篇文章写得很好，看看就明白了。</p>

<p><a href="https://ruby-china.org/topics/22332">https://ruby-china.org/topics/22332</a></p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2015-01-30T16:04:25+08:00" pubdate data-updated="true"></time></div>
	<div class="tags">

</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/12/26/zai-ruby-zhong-yong-ssh-lai-gen-fu-wu-qi-jin-xing-tong-xin/">
		
			在 Ruby 中用 SSH 来跟服务器进行通信</a>
	</h2>
	<div class="entry-content">
		<h1>在Ruby中用SSH跟服务器进行交流</h1>

<h2>前言</h2>

<p>Net::SSH和Net::SCP是两个Ruby操作SSH的gem包。</p>

<p>Net::SSH相当于cmd，专门用于执行命令；</p>

<p>Net::SCP专门用于传输文件。</p>

<p>它们俩结合，可以做任何SSH client能做的事情。</p>

<h2>所需 Gem</h2>

<ol>
<li>gem &lsquo;net-ssh&rsquo;</li>
<li>gem &lsquo;net-scp&rsquo;</li>
</ol>


<h2>Begin</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Net</span><span class="o">::</span><span class="no">SSH</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="no">MYSQL_SYNC_CONFIG</span><span class="o">[</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">sequence</span><span class="si">}</span><span class="s2">_server_ip&quot;</span><span class="o">]</span><span class="p">,</span> <span class="no">MYSQL_SYNC_CONFIG</span><span class="o">[</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">sequence</span><span class="si">}</span><span class="s2">_server_user&quot;</span><span class="o">]</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">ssh</span><span class="o">|</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1"># 创建文件夹</span>
</span><span class='line'>        <span class="n">ssh</span><span class="o">.</span><span class="n">exec!</span><span class="p">(</span>
</span><span class='line'>          <span class="s2">&quot;if [ ! -d </span><span class="si">#{</span><span class="no">MYSQL_SYNC_CONFIG</span><span class="o">[</span><span class="s1">&#39;endpoint_backup_path&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2"> ]; then</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="p">\</span>
</span><span class='line'>          <span class="s2">&quot;mkdir </span><span class="si">#{</span><span class="no">MYSQL_SYNC_CONFIG</span><span class="o">[</span><span class="s1">&#39;endpoint_backup_path&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">;&quot;</span> <span class="p">\</span>
</span><span class='line'>          <span class="s2">&quot;fi&quot;</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1"># 开始上传</span>
</span><span class='line'>        <span class="n">ssh</span><span class="o">.</span><span class="n">scp</span><span class="o">.</span><span class="n">upload!</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">backup_sql_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="no">MYSQL_SYNC_CONFIG</span><span class="o">[</span><span class="s1">&#39;endpoint_backup_path&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">backup_sql_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1"># 客户端开始还原</span>
</span><span class='line'>        <span class="n">ssh</span><span class="o">.</span><span class="n">exec!</span><span class="p">(</span><span class="s2">&quot;mysql -u&quot;</span> <span class="o">+</span> <span class="no">MYSQL_SYNC_CONFIG</span><span class="o">[</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">sequence</span><span class="si">}</span><span class="s2">_server_mysql_user&quot;</span><span class="o">]</span> <span class="o">+</span>
</span><span class='line'>                  <span class="s2">&quot; -p&quot;</span> <span class="o">+</span> <span class="no">MYSQL_SYNC_CONFIG</span><span class="o">[</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">sequence</span><span class="si">}</span><span class="s2">_server_mysql_pwd&quot;</span><span class="o">]</span> <span class="o">+</span>
</span><span class='line'>                  <span class="s2">&quot; red_mansions &lt; </span><span class="si">#{</span><span class="no">MYSQL_SYNC_CONFIG</span><span class="o">[</span><span class="s1">&#39;endpoint_backup_path&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">backup_sql_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h2>引用</h2>

<p><a href="http://rubyer.me/blog/1133/">http://rubyer.me/blog/1133/</a></p>

<p><a href="http://www.infoq.com/cn/articles/ruby-file-upload-ssh-intro">http://www.infoq.com/cn/articles/ruby-file-upload-ssh-intro</a></p>

<p><a href="https://gist.github.com/lajunta/7305741">https://gist.github.com/lajunta/7305741</a></p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-12-26T15:01:21+08:00" pubdate data-updated="true"></time></div>
	<div class="tags">

</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/12/26/shi-yong-rsync/">
		
			使用 Rsync</a>
	</h2>
	<div class="entry-content">
		<h1>使用rsync</h1>

<h2>1. 服务器端</h2>

<p><code>/etc/rsyncd.conf</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">uid</span> <span class="o">=</span> deploy
</span><span class='line'><span class="nv">gid</span> <span class="o">=</span> deploy
</span><span class='line'>use <span class="nv">chroot</span> <span class="o">=</span> no
</span><span class='line'>max <span class="nv">connections</span> <span class="o">=</span> 4
</span><span class='line'>pid <span class="nv">file</span> <span class="o">=</span> /var/run/rsyncd.pid
</span><span class='line'>lock <span class="nv">file</span> <span class="o">=</span> /var/run/rsyncd.lock
</span><span class='line'>log <span class="nv">file</span> <span class="o">=</span> /var/log/rsyncd.log
</span><span class='line'>
</span><span class='line'><span class="o">[</span><span class="nb">test</span><span class="o">]</span>
</span><span class='line'><span class="nv">path</span> <span class="o">=</span> /var/test
</span><span class='line'>ignore errors
</span><span class='line'><span class="nb">read </span><span class="nv">only</span> <span class="o">=</span> <span class="nb">true</span>
</span><span class='line'><span class="nv">list</span> <span class="o">=</span> <span class="nb">false</span>
</span><span class='line'>auth <span class="nv">users</span> <span class="o">=</span> fuck
</span><span class='line'>secrets <span class="nv">file</span> <span class="o">=</span> /etc/backserver.pas
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p><code>/etc/backserver.pas</code> （ 需要设置权限400）</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>hello:world   <span class="o">(</span>该账号密码最好不跟服务器一样）
</span></code></pre></td></tr></table></div></figure>


<p><code>usr/bin/rsync --daemon</code> 启动服务</p>

<p><code>echo "/usr/local/rsync/bin/rsync --daemon" &gt;&gt; /etc/rc.local</code> 开机自启动</p>

<h2>2. 客户端</h2>

<h3>2.1 同步方式</h3>

<h4>2.1.1. 第一种方式是 服务器–客户端方式。</h4>

<p>这种方式，服务器启动 daemon 守护线程，监听端口 873，并配置需要同步的模块，然后客户端连接 873 端口，认证并同步。</p>

<p>其中，同步所使用的账号密码是 rsync  单独配置的，与系统无关。</p>

<p>服务端运行rsync进程在daemon模式下， 客户端是普通的rsync进程。</p>

<h4>2.1.2. 使用 ssh 方式</h4>

<p>本机 rsync 进程 直接通过 ssh 通道连接到远程， 并在远程ssh通道执行命令</p>

<p>两者是走不同协议，不同端口的，因此第一种方式服务器是不需要启动 rsync 服务的，当然还是需要安装这个程序</p>

<h3>2.2 使用账号密码登录（此时服务器需要启动 rsync &ndash;daemon 服务）</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>USER@HOST::MODE  <span class="c"># mode 是服务器设置好的模块名，这里不能用路径,注意两个冒号</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>/etc/rsync_client.pas</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>glassx <span class="c"># 只需要配置连接时使用的密码即可，必须与A服务器上定义的密码相同.</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>chmod 600 /etc/rsync_client.pas</code></p>

<p><code>usr/bin/rsync -vzrtopg --progress --delete --password-file=/etc/rsync_client.secrets  hello@192.168.10.240::test   /var/rsync/test</code></p>

<p>跟在IP后的<code>test</code> 是指服务端配置的模块</p>

<h3>2.3 使用SSH （ 此时服务器不需要启动 rsync &ndash;daemon 服务）</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>USER@HOST:Folder <span class="c"># 注意只有一个冒号,rsync由此判断使用ssh通道。而不是直接连接远端的873端口。</span>
</span><span class='line'>
</span><span class='line'><span class="c"># 使用了SSH后，就不能再用 :test 了，而是要跟纯路径。</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>usr/bin/rsync -vzrtopg --progress --delete -e ssh deploy@192.168.10.240:/home/deploy/test   /home/deploy/test</code></p>

<p>注意权限的问题，本地文件夹要有足够权限去同步文件（也不能在该命令前加 sudo, 这样用ssh时会错乱，如果用密码连接则可以）</p>

<h3>2.4 参考</h3>

<p><a href="http://blog.sina.com.cn/s/blog_544f183101013zlo.html">http://blog.sina.com.cn/s/blog_544f183101013zlo.html</a></p>

<p><a href="http://tech.huweishen.com/gongju/1529.html">http://tech.huweishen.com/gongju/1529.html</a></p>

<p><a href="http://www.cszhi.com/20120312/rsync-simple.html">http://www.cszhi.com/20120312/rsync-simple.html</a></p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-12-26T15:00:40+08:00" pubdate data-updated="true"></time></div>
	<div class="tags">

</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/12/26/mina-jian-jie-shi-yong/">
		
			Mina 简介使用</a>
	</h2>
	<div class="entry-content">
		<h1>说下 Mina</h1>

<h2>一、基本使用</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">gem</span> <span class="s1">&#39;ruby&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">mina</span> <span class="n">init</span>    <span class="o">=&gt;</span>  <span class="err">生成</span> <span class="n">config</span><span class="o">/</span><span class="n">deploy</span><span class="o">.</span><span class="n">rb</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># config/deploy.rb</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:user</span><span class="p">,</span> <span class="s1">&#39;username&#39;</span>  <span class="c1"># 部署用户</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:domain</span><span class="p">,</span> <span class="s1">&#39;your.server.com&#39;</span>   <span class="c1"># 域名</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:deploy_to</span><span class="p">,</span> <span class="s1">&#39;/var/www/flipstack.com&#39;</span> <span class="c1"># 部署路径</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:repository</span><span class="p">,</span> <span class="s1">&#39;git@github.......xxx&#39;</span> <span class="c1">#git 仓库</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:branch</span><span class="p">,</span> <span class="s1">&#39;master&#39;</span> <span class="c1">#分支</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:shared_paths</span><span class="p">,</span> <span class="o">[</span><span class="s1">&#39;config/database.yml&#39;</span><span class="p">,</span> <span class="s1">&#39;public/system&#39;</span> <span class="o">.</span><span class="n">.</span><span class="o">.]</span> <span class="c1">#共享文件夹</span>
</span><span class='line'>
</span><span class='line'><span class="err">然后：</span>
</span><span class='line'>
</span><span class='line'><span class="mi">1</span><span class="o">.</span>
</span><span class='line'><span class="ss">task</span><span class="p">:</span> <span class="n">environment</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">invoke</span> <span class="ss">:&#39;rvm:use[ruby-2.0.0@rails4.0.4]&#39;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="mi">2</span><span class="o">.</span>
</span><span class='line'><span class="c1"># 主要为 deploy 做准备，创建各个文件夹</span>
</span><span class='line'><span class="n">task</span> <span class="ss">:setup</span> <span class="o">=&gt;</span> <span class="ss">:environment</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">queue!</span> <span class="sx">%[mkdir -p &quot;</span><span class="si">#{</span><span class="n">deploy_to</span><span class="si">}</span><span class="sx">/shared/log&quot;]</span>
</span><span class='line'>  <span class="n">queue!</span> <span class="sx">%[chmod g+rx,u+rwx &quot;</span><span class="si">#{</span><span class="n">deploy_to</span><span class="si">}</span><span class="sx">/shared/log&quot;]</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">queue!</span> <span class="sx">%[mkdir -p &quot;</span><span class="si">#{</span><span class="n">deploy_to</span><span class="si">}</span><span class="sx">/shared/config&quot;]</span>
</span><span class='line'>  <span class="n">queue!</span> <span class="sx">%[chmod g+rx,u+rwx &quot;</span><span class="si">#{</span><span class="n">deploy_to</span><span class="si">}</span><span class="sx">/shared/config&quot;]</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">queue!</span> <span class="sx">%[mkdir -p &quot;</span><span class="si">#{</span><span class="n">deploy_to</span><span class="si">}</span><span class="sx">/shared/public/qrcodes&quot;]</span>
</span><span class='line'>  <span class="n">queue!</span> <span class="sx">%[mkdir -p &quot;</span><span class="si">#{</span><span class="n">deploy_to</span><span class="si">}</span><span class="sx">/shared/public/qrcodesZip&quot;]</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">queue!</span> <span class="sx">%[mkdir -p &quot;</span><span class="si">#{</span><span class="n">deploy_to</span><span class="si">}</span><span class="sx">/shared/public/uploads&quot;]</span>
</span><span class='line'>  <span class="n">queue!</span> <span class="sx">%[mkdir -p &quot;</span><span class="si">#{</span><span class="n">deploy_to</span><span class="si">}</span><span class="sx">/shared/public/system&quot;]</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">queue!</span> <span class="sx">%[mkdir -p &quot;</span><span class="si">#{</span><span class="n">deploy_to</span><span class="si">}</span><span class="sx">/shared/coupons&quot;]</span>
</span><span class='line'>  <span class="n">queue!</span> <span class="sx">%[chmod g+rx,u+rwx &quot;</span><span class="si">#{</span><span class="n">deploy_to</span><span class="si">}</span><span class="sx">/shared/coupons&quot;]</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">queue!</span> <span class="sx">%[mkdir -p &quot;</span><span class="si">#{</span><span class="n">deploy_to</span><span class="si">}</span><span class="sx">/shared/couponsZip&quot;]</span>
</span><span class='line'>  <span class="n">queue!</span> <span class="sx">%[chmod g+rx,u+rwx &quot;</span><span class="si">#{</span><span class="n">deploy_to</span><span class="si">}</span><span class="sx">/shared/couponsZip&quot;]</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">queue!</span> <span class="sx">%[touch &quot;</span><span class="si">#{</span><span class="n">deploy_to</span><span class="si">}</span><span class="sx">/shared/config/database.yml&quot;]</span>
</span><span class='line'>  <span class="n">queue</span>  <span class="sx">%[echo &quot;-----&gt; Be sure to edit &#39;shared/config/database.yml&#39;.&quot;]</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="mi">3</span><span class="o">.</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 编写部署任务</span>
</span><span class='line'><span class="n">task</span> <span class="ss">:deploy</span> <span class="o">=&gt;</span> <span class="ss">:environment</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">deploy</span> <span class="k">do</span>
</span><span class='line'>    <span class="c1"># Put things that will set up an empty directory into a fully set-up</span>
</span><span class='line'>    <span class="c1"># instance of your project.</span>
</span><span class='line'>    <span class="n">invoke</span> <span class="ss">:&#39;sidekiq:quiet&#39;</span>
</span><span class='line'>    <span class="n">invoke</span> <span class="ss">:&#39;git:clone&#39;</span>
</span><span class='line'>    <span class="n">invoke</span> <span class="ss">:&#39;deploy:link_shared_paths&#39;</span>
</span><span class='line'>    <span class="n">invoke</span> <span class="ss">:&#39;bundle:install&#39;</span>
</span><span class='line'>    <span class="n">invoke</span> <span class="ss">:&#39;rails:db_migrate&#39;</span>
</span><span class='line'>    <span class="n">invoke</span> <span class="ss">:&#39;rails:assets_precompile&#39;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">to</span> <span class="ss">:launch</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">queue</span> <span class="s2">&quot;if [ -d </span><span class="si">#{</span><span class="n">deploy_to</span><span class="si">}</span><span class="s2">/current/tmp ]</span>
</span><span class='line'><span class="s2">      then</span>
</span><span class='line'><span class="s2">        touch </span><span class="si">#{</span><span class="n">deploy_to</span><span class="si">}</span><span class="s2">/current/tmp/restart.txt</span>
</span><span class='line'><span class="s2">      else</span>
</span><span class='line'><span class="s2">        mkdir </span><span class="si">#{</span><span class="n">deploy_to</span><span class="si">}</span><span class="s2">/current/tmp</span>
</span><span class='line'><span class="s2">        touch </span><span class="si">#{</span><span class="n">deploy_to</span><span class="si">}</span><span class="s2">/current/tmp/restart.txt </span>
</span><span class='line'><span class="s2">      fi&quot;</span>
</span><span class='line'>      <span class="n">invoke</span> <span class="ss">:&#39;sidekiq:restart&#39;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>终端执行</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">mina</span> <span class="n">setup</span>
</span><span class='line'>
</span><span class='line'><span class="n">mina</span> <span class="n">deploy</span>
</span></code></pre></td></tr></table></div></figure>


<h2>二、应该要注意的 <code>point</code></h2>

<p>1、我们可以自己写 task 任务</p>

<p>2、queue 命令用在执行 bash 命令，如：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">task</span> <span class="ss">:logs</span> <span class="k">do</span>
</span><span class='line'>     <span class="n">queue</span> <span class="s1">&#39;echo &quot;Contents of the log file are as follows:&quot;&#39;</span>
</span><span class='line'>     <span class="n">queue</span> <span class="s2">&quot;tail -f /var/log/apache.log&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>3、invoke 命令用在引用已经写好的 task 任务，如：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">task</span> <span class="ss">:down</span> <span class="k">do</span>
</span><span class='line'>     <span class="n">invoke</span> <span class="ss">:maintenance</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">task</span> <span class="ss">:maintenance</span> <span class="k">do</span>
</span><span class='line'>     <span class="n">queue</span> <span class="s1">&#39;touch maintenance.txt&#39;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>4、Mina 已经有一些已经写好的 task 任务，如：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">invoke</span> <span class="ss">:&#39;git:clone&#39;</span>
</span><span class='line'><span class="n">invoke</span> <span class="ss">:&#39;bundle:install&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#我一开始以为这是执行 bash 命令，让我理不清 invoke 跟 queue 的关系</span>
</span></code></pre></td></tr></table></div></figure>


<p>5、<code>run!</code> 这个命令是指 SSH 进主机，然后执行所有已经 queue 的命令。这个命令会在 Rake 退出前，自动调用。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># 当 rake 退出时会调用。</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">mina_cleanup</span>
</span><span class='line'>    <span class="n">run!</span> <span class="k">if</span> <span class="n">commands</span><span class="o">.</span><span class="n">any?</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>6、<code>command</code> 包含所有已经 queue 的任务</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">queue</span> <span class="s2">&quot;sudo restart&quot;</span>
</span><span class='line'><span class="n">queue</span> <span class="s2">&quot;true&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="n">to</span> <span class="ss">:clean</span> <span class="k">do</span>     <span class="c1"># 这里 clean 的queue 会被放到 :clean 命名空间下</span>
</span><span class='line'>  <span class="n">queue</span> <span class="s2">&quot;rm&quot;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">commands</span> <span class="o">==</span> <span class="o">[</span><span class="s2">&quot;sudo restart&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="o">]</span>
</span><span class='line'><span class="n">commands</span><span class="p">(</span><span class="ss">:clean</span><span class="p">)</span> <span class="o">==</span> <span class="o">[</span><span class="s2">&quot;rm&quot;</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="err">注意了，</span><span class="n">commands</span> <span class="err">是一个方法，而不是变量</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 源代码</span>
</span><span class='line'><span class="k">def</span> <span class="nf">commands</span><span class="p">(</span><span class="n">aspect</span><span class="o">=</span><span class="ss">:default</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="vi">@commands</span> <span class="o">||=</span> <span class="k">begin</span>
</span><span class='line'>    <span class="vi">@to</span> <span class="o">=</span> <span class="ss">:default</span>
</span><span class='line'>    <span class="no">Hash</span><span class="o">.</span><span class="n">new</span> <span class="p">{</span> <span class="o">|</span><span class="n">h</span><span class="p">,</span> <span class="n">k</span><span class="o">|</span> <span class="n">h</span><span class="o">[</span><span class="n">k</span><span class="o">]</span> <span class="o">=</span> <span class="nb">Array</span><span class="o">.</span><span class="n">new</span> <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span><span class="p">)</span><span class="o">[</span><span class="n">aspect</span><span class="o">]</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="err">因此如果要清空</span> <span class="n">commands</span><span class="err">，应该是执行</span><span class="p">:</span>
</span><span class='line'>
</span><span class='line'><span class="vi">@commands</span><span class="o">[</span><span class="ss">:default</span><span class="o">]</span> <span class="o">=</span> <span class="o">[]</span>
</span></code></pre></td></tr></table></div></figure>


<p>7、<code>isolate</code> 命令会开辟一个新的 block，包含 queue 的任务</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">queue</span> <span class="s2">&quot;sudo restart&quot;</span>
</span><span class='line'><span class="n">queue</span> <span class="s2">&quot;true&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="n">commands</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="o">[</span><span class="s1">&#39;sudo restart&#39;</span><span class="p">,</span> <span class="s1">&#39;true&#39;</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="n">isolate</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">queue</span> <span class="s2">&quot;reload&quot;</span>
</span><span class='line'>  <span class="n">commands</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="o">[</span><span class="s1">&#39;reload&#39;</span><span class="o">]</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">commands</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="o">[</span><span class="s1">&#39;sudo restart&#39;</span><span class="p">,</span> <span class="s1">&#39;true&#39;</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>8、已被 invoke 的 task, 再次被 invoke 时，是不会再次被执行的，除非：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># 该参数表明再次invoke时会继续执行一次。</span>
</span><span class='line'><span class="n">invoke</span> <span class="ss">:setup</span><span class="p">,</span> <span class="p">{</span><span class="ss">reenable</span><span class="p">:</span> <span class="kp">true</span><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 注意，任务是否已经被 invoke 过，并不是通过 commands 内的值来判断的，因此就算 commands 清空了，task 还是会被标记成已 invoke 过的。</span>
</span></code></pre></td></tr></table></div></figure>


<p>9、</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">task</span> <span class="ss">:hello</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">set</span> <span class="ss">:deploy_to</span><span class="p">,</span> <span class="s1">&#39;hellooooooooo&#39;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">task</span> <span class="ss">:world</span> <span class="k">do</span>
</span><span class='line'>  <span class="nb">p</span> <span class="n">deploy_to</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="err">$</span><span class="o">-&gt;</span> <span class="n">mina</span> <span class="n">hello</span> <span class="n">world</span>
</span><span class='line'>
</span><span class='line'><span class="o">===&gt;</span>  <span class="s1">&#39;hellooooooooo&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="err">说明</span> <span class="n">mina</span> <span class="n">task1</span> <span class="n">task2</span> <span class="err">是可以串行执行的，并且任务</span><span class="mi">1</span><span class="err">的环境会跟任务</span><span class="mi">2</span><span class="err">相连。（同个执行环境）</span>
</span><span class='line'><span class="err">通常用在设置不同的</span> <span class="n">stage</span>
</span></code></pre></td></tr></table></div></figure>


<h2>三、多机部署</h2>

<h3>一、将同一项目部署到多个服务器</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">set</span> <span class="ss">:domains</span><span class="p">,</span> <span class="sx">%w[192.168.0.12 192.168.0.13]</span>
</span><span class='line'>
</span><span class='line'><span class="n">desc</span> <span class="s2">&quot;multi deploy&quot;</span>
</span><span class='line'><span class="n">task</span> <span class="ss">:multi_deploy</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">domains</span><span class="o">.</span><span class="n">each_with_index</span> <span class="k">do</span> <span class="o">|</span><span class="n">domain</span><span class="p">,</span> <span class="n">index</span><span class="o">|</span>
</span><span class='line'>
</span><span class='line'>      <span class="nb">p</span> <span class="s2">&quot;begin to deploy</span><span class="si">#{</span><span class="n">domain</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>      <span class="n">set</span> <span class="ss">:domain</span><span class="p">,</span> <span class="n">domain</span>
</span><span class='line'>      <span class="n">invoke</span> <span class="ss">:deploy</span>
</span><span class='line'>      <span class="n">run!</span>    <span class="o">=&gt;</span> <span class="c1"># 注意这里一定要加上 run! ，才会立即运行命令</span>
</span><span class='line'>      <span class="nb">p</span> <span class="s2">&quot;finish to deploy&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>自己写的一个 task, 这时候遇到一个难题，发现 invoke :deploy ，当第一次循环的时候正常，第二次循环的时候，会部署两次。</p>

<p>效果是这样的：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="k">begin</span> <span class="n">to</span> <span class="n">deploy</span> <span class="n">server</span> <span class="mi">192</span><span class="o">.</span><span class="mi">168</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">12</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">deploying</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>
</span><span class='line'> <span class="n">finish</span> <span class="n">to</span> <span class="n">deploy</span> <span class="n">server</span> <span class="mi">192</span><span class="o">.</span><span class="mi">168</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">12</span>
</span><span class='line'>
</span><span class='line'> <span class="k">begin</span> <span class="n">to</span> <span class="n">deploy</span> <span class="n">server</span> <span class="mi">192</span><span class="o">.</span><span class="mi">168</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">13</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">deploying</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>
</span><span class='line'> <span class="n">finish</span> <span class="n">to</span> <span class="n">deploy</span> <span class="n">server</span> <span class="mi">192</span><span class="o">.</span><span class="mi">168</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">13</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">deploying</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span>  <span class="p">(</span> <span class="n">server</span> <span class="mi">192</span><span class="o">.</span><span class="mi">168</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">13</span> <span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>如果我的 domains  是</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">set</span> <span class="ss">:domains</span><span class="p">,</span> <span class="sx">%w[192.168.0.12 192.168.0.13 192.168.0.14]</span>
</span></code></pre></td></tr></table></div></figure>


<p>那么效果会是：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="k">begin</span> <span class="n">to</span> <span class="n">deploy</span> <span class="n">server</span> <span class="mi">192</span><span class="o">.</span><span class="mi">168</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">12</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">deploying</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>
</span><span class='line'> <span class="n">finish</span> <span class="n">to</span> <span class="n">deploy</span> <span class="n">server</span> <span class="mi">192</span><span class="o">.</span><span class="mi">168</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">12</span>
</span><span class='line'>
</span><span class='line'> <span class="k">begin</span> <span class="n">to</span> <span class="n">deploy</span> <span class="n">server</span> <span class="mi">192</span><span class="o">.</span><span class="mi">168</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">13</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">deploying</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>
</span><span class='line'> <span class="n">finish</span> <span class="n">to</span> <span class="n">deploy</span> <span class="n">server</span> <span class="mi">192</span><span class="o">.</span><span class="mi">168</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">13</span>
</span><span class='line'>
</span><span class='line'> <span class="k">begin</span> <span class="n">to</span> <span class="n">deploy</span> <span class="n">server</span> <span class="mi">192</span><span class="o">.</span><span class="mi">168</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">14</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">deploying</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>
</span><span class='line'> <span class="n">finish</span> <span class="n">to</span> <span class="n">deploy</span> <span class="n">server</span> <span class="mi">192</span><span class="o">.</span><span class="mi">168</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">14</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">deploying</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span>  <span class="p">(</span> <span class="n">server</span> <span class="mi">192</span><span class="o">.</span><span class="mi">168</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">14</span> <span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>发觉最终总是会多部署最后一个server</p>

<p>于是我用</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">p</span> <span class="s2">&quot;命令集合：</span><span class="si">#{</span><span class="n">commands</span><span class="p">(</span><span class="ss">:default</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>来查看，也没有什么异常。</p>

<p>然后我又做了下实验：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">task</span> <span class="ss">:deploy_primary</span> <span class="k">do</span>
</span><span class='line'>  <span class="nb">p</span> <span class="s2">&quot;begin to deploy primary </span><span class="si">#{</span><span class="n">primary_domain</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="n">set</span> <span class="ss">:domain</span><span class="p">,</span> <span class="n">primary_domain</span>
</span><span class='line'>  <span class="n">invoke</span> <span class="ss">:deploy</span>
</span><span class='line'>  <span class="n">invoke</span> <span class="ss">:mysql_sync</span>
</span><span class='line'>  <span class="n">run!</span>
</span><span class='line'>  <span class="nb">p</span> <span class="s2">&quot;finish to deploy primary </span><span class="si">#{</span><span class="n">primary_domain</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="nb">p</span> <span class="n">commands</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h3>原因</h3>

<p>在 rake 退出前会自动调用 <code>run!</code> 这个方法，因此到最后是会多执行一次 commands 内的命令的。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">mina_cleanup!</span>
</span><span class='line'>  <span class="n">run!</span> <span class="k">if</span> <span class="n">commands</span><span class="o">.</span><span class="n">any?</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h3>解决方法</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">set</span> <span class="ss">:domains</span><span class="p">,</span> <span class="sx">%w[192.168.0.12 192.168.0.13]</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="n">desc</span> <span class="s2">&quot;multi deploy&quot;</span>
</span><span class='line'><span class="n">task</span> <span class="ss">:multi_deploy</span> <span class="k">do</span>
</span><span class='line'>   <span class="n">isolate</span> <span class="k">do</span>   <span class="c1"># =&gt;  开辟一个新的 block (这样isolate外面的commands为[]）</span>
</span><span class='line'>    <span class="n">domains</span><span class="o">.</span><span class="n">each_with_index</span> <span class="k">do</span> <span class="o">|</span><span class="n">domain</span><span class="p">,</span> <span class="n">index</span><span class="o">|</span>
</span><span class='line'>      <span class="nb">p</span> <span class="s2">&quot;begin to deploy</span><span class="si">#{</span><span class="n">domain</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>      <span class="n">set</span> <span class="ss">:domain</span><span class="p">,</span> <span class="n">domain</span>
</span><span class='line'>      <span class="c1"># 这里其实只 invoke 了一次，之所以执行了三次，是因为有三次 run!</span>
</span><span class='line'>      <span class="c1"># 而 domain 参数并不是写进 commands 的，而是在 run! 的时候进行处理</span>
</span><span class='line'>      <span class="c1"># 因此这里可以成功的分别部署到三台机器</span>
</span><span class='line'>      <span class="n">invoke</span> <span class="ss">:deploy</span>
</span><span class='line'>      <span class="n">run!</span>
</span><span class='line'>      <span class="nb">p</span> <span class="s2">&quot;finish to deploy&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="c1"># rake 任务退出时执行 run!, 但此时 commands 为 []</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h3>二、将同一项目部署到同一机器的两个目录</h3>

<p>因为该项目需要做全站国际化，因此我将它分别部署为两套 server.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">task</span> <span class="ss">:deploy_all</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">isolate</span> <span class="k">do</span>
</span><span class='line'>    <span class="mi">2</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">sequence</span><span class="o">|</span>
</span><span class='line'>      <span class="nb">p</span> <span class="s2">&quot;begin to deploy </span><span class="si">#{</span><span class="n">sequence</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">sequence</span> <span class="o">==</span> <span class="mi">0</span>
</span><span class='line'>        <span class="n">set</span> <span class="ss">:deploy_to</span><span class="p">,</span> <span class="s1">&#39;/home/deploy/xshare_en&#39;</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>        <span class="n">set</span> <span class="ss">:deploy_to</span><span class="p">,</span> <span class="s1">&#39;/home/deploy/xshare_zh&#39;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="n">invoke</span> <span class="ss">:deploy</span>
</span><span class='line'>      <span class="n">run!</span>
</span><span class='line'>      <span class="nb">p</span> <span class="s2">&quot;end to deploy </span><span class="si">#{</span><span class="n">sequence</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>这么做的后果是：部署了两次到 <code>/home/deploy/xshare_en</code>去了。</p>

<h3>原因</h3>

<p>1、 <code>deploy_to</code> 的值是直接写进 <code>commands</code> 内的</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">[.</span><span class="n">.</span><span class="o">.</span><span class="n">Setting</span> <span class="n">up</span> <span class="sr">/home/</span><span class="n">deploy</span><span class="o">/</span><span class="n">xshare_zh</span><span class="p">\</span><span class="s2">&quot; &amp;&amp; (</span><span class="se">\n</span><span class="s2">  mkdir -p </span><span class="se">\&quot;</span><span class="s2">/home/deploy/xshare_zh</span><span class="se">\&quot;</span><span class="s2"> &amp;&amp;</span><span class="se">\n</span><span class="s2">  chown -R `whoami` </span><span class="se">\&quot;</span><span class="s2">/home/deploy/xshare_zh</span><span class="se">\&quot;</span><span class="s2"> &amp;&amp;</span><span class="se">\n</span><span class="s2">  chmod g+rx,u+rwx </span><span class="se">\&quot;</span><span class="s2">/home/deploy/xshare_zh</span><span class="se">\&quot;</span><span class="s2"> &amp;&amp;\....]</span>
</span></code></pre></td></tr></table></div></figure>


<p>2、这里 <code>:deploy</code> 只 <code>invoke</code> 了一次，因此 commands 内的值是没有变化的，所以相当于执行了两次一样的第一次<code>commands</code></p>

<h3>尝试1</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">task</span> <span class="ss">:deploy_all</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">isolate</span> <span class="k">do</span>
</span><span class='line'>    <span class="mi">2</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">sequence</span><span class="o">|</span>
</span><span class='line'>      <span class="nb">p</span> <span class="s2">&quot;begin to deploy </span><span class="si">#{</span><span class="n">sequence</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">sequence</span> <span class="o">==</span> <span class="mi">0</span>
</span><span class='line'>        <span class="n">set</span> <span class="ss">:deploy_to</span><span class="p">,</span> <span class="s1">&#39;/home/deploy/xshare_en&#39;</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>        <span class="n">set</span> <span class="ss">:deploy_to</span><span class="p">,</span> <span class="s1">&#39;/home/deploy/xshare_zh&#39;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="c1"># 重复 invoke</span>
</span><span class='line'>      <span class="n">invoke</span> <span class="ss">:deploy</span><span class="p">,</span> <span class="ss">reenable</span><span class="p">:</span> <span class="kp">true</span>
</span><span class='line'>      <span class="n">run!</span>
</span><span class='line'>      <span class="c1"># 清空 commands</span>
</span><span class='line'>      <span class="vi">@commands</span><span class="o">[</span><span class="ss">:default</span><span class="o">]</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>      <span class="nb">p</span> <span class="s2">&quot;end to deploy </span><span class="si">#{</span><span class="n">sequence</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>结果还是没达到预料中的结果。</p>

<p>因为<code>task deploy</code> 中还 <code>invoke</code> 了其他的 <code>task</code>,比如<code>git:clone</code>，因此其他的<code>task</code>只算invoke了一次，就算我手动将<code>deploy</code>所引用的<code>task</code>全部都加<code>reenable</code>参数，还是不行，因为难保其他task没invoke另外的task</p>

<h3>尝试2</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">task</span> <span class="ss">:deploy_all</span> <span class="k">do</span>
</span><span class='line'>  <span class="mi">2</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">sequence</span><span class="o">|</span>
</span><span class='line'>  <span class="c1"># 尝试将两者区分开block</span>
</span><span class='line'>    <span class="n">isolate</span> <span class="k">do</span>
</span><span class='line'>      <span class="nb">p</span> <span class="s2">&quot;begin to deploy </span><span class="si">#{</span><span class="n">sequence</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">sequence</span> <span class="o">==</span> <span class="mi">0</span>
</span><span class='line'>        <span class="n">set</span> <span class="ss">:deploy_to</span><span class="p">,</span> <span class="s1">&#39;/home/deploy/xshare_en&#39;</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>        <span class="n">set</span> <span class="ss">:deploy_to</span><span class="p">,</span> <span class="s1">&#39;/home/deploy/xshare_zh&#39;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="c1"># 重复 invoke</span>
</span><span class='line'>      <span class="n">invoke</span> <span class="ss">:deploy</span>
</span><span class='line'>      <span class="n">run!</span>
</span><span class='line'>      <span class="c1"># 清空 commands</span>
</span><span class='line'>      <span class="vi">@commands</span><span class="o">[</span><span class="ss">:default</span><span class="o">]</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>      <span class="nb">p</span> <span class="s2">&quot;end to deploy </span><span class="si">#{</span><span class="n">sequence</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>但还是失败，:deploy 是否被 invoke,跟 isolate 无关，因为 isolate 控制的只是 commands 而已。</p>

<h3>解决</h3>

<p><code>没找到好办法，暂时分开task执行，不过这种使用场景也比较少。</code></p>

<h2>单独执行命令</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">task</span> <span class="ss">:mysql_sync</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">queue</span> <span class="sx">%[cd </span><span class="si">#{</span><span class="n">deploy_to!</span><span class="si">}</span><span class="sx">/current &amp;&amp; whenever -i &#39;mysql_sync&#39;]</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>当初单独执行这个 task  的时候，一直提示找不到 whenever 这个命令，令人纳闷，最终发现需要加上环境。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">task</span> <span class="ss">:mysql_sync</span> <span class="o">=&gt;</span> <span class="ss">:environment</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">queue</span> <span class="sx">%[cd </span><span class="si">#{</span><span class="n">deploy_to!</span><span class="si">}</span><span class="sx">/current &amp;&amp; whenever -i &#39;mysql_sync&#39;]</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h2>重复的 queue</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">set</span> <span class="ss">:domains</span><span class="p">,</span> <span class="sx">%w[192.168.0.12 192.168.0.13]</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="n">desc</span> <span class="s2">&quot;multi deploy&quot;</span>
</span><span class='line'><span class="n">task</span> <span class="ss">:multi_deploy</span> <span class="k">do</span>
</span><span class='line'>   <span class="n">isolate</span> <span class="k">do</span>   <span class="c1"># =&gt;  开辟一个新的 block ( 不过为何能解决我还没弄懂）</span>
</span><span class='line'>    <span class="n">domains</span><span class="o">.</span><span class="n">each_with_index</span> <span class="k">do</span> <span class="o">|</span><span class="n">domain</span><span class="p">,</span> <span class="n">index</span><span class="o">|</span>
</span><span class='line'>      <span class="nb">p</span> <span class="s2">&quot;begin to deploy</span><span class="si">#{</span><span class="n">domain</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>      <span class="n">set</span> <span class="ss">:domain</span><span class="p">,</span> <span class="n">domain</span>
</span><span class='line'>      <span class="n">invoke</span> <span class="ss">:deploy</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">1</span>
</span><span class='line'>         <span class="n">queue</span> <span class="s1">&#39;do something one&#39;</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>         <span class="n">queue</span> <span class="s1">&#39;do something two&#39;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="n">run!</span>    <span class="o">=&gt;</span> <span class="c1"># 注意这里一定要加上 run! ，才会立即运行命令</span>
</span><span class='line'>      <span class="nb">p</span> <span class="s2">&quot;finish to deploy&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>这样子的话，当第二次循环时，会执行 <code>one</code> 和 <code>two</code> 两个 queue, 因为第一次循环时， <code>one</code> 已经 queued 了，进入了 commands，因此第二次循环时，会执行这个命令 （  执行所有 commands)</p>

<p>这是个难点。我还没找到解决方法。只能说分开来执行,或者写脚本根据不同服务器执行不同命令</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-12-26T15:00:12+08:00" pubdate data-updated="true"></time></div>
	<div class="tags">

</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/12/26/shi-yong-capistrano-lai-bu-shu-ying-yong/">
		
			使用 Capistrano 来部署应用</a>
	</h2>
	<div class="entry-content">
		<h1>使用 Capistrano 部署应用</h1>

<h2>前言</h2>

<p>由于 Mina 一直以简单好用为著称，因此一直都是用 Mina 来部署应用。但是  Mina 也有局限性，之前的多机部署就遇到了难题，于是学习下如何用 Capistrano 来部署 Rails 应用</p>

<h2>使用环境</h2>

<ol>
<li>Capistrano 3.x</li>
<li>Rails4.1</li>
<li>Ruby2.0</li>
<li>RVM</li>
</ol>


<h2>安装</h2>

<p>在<code>gemfile</code>中添加支持的 gem</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">group</span> <span class="ss">:development</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">gem</span> <span class="s1">&#39;capistrano&#39;</span>
</span><span class='line'>  <span class="n">gem</span> <span class="s1">&#39;capistrano-bundler&#39;</span>
</span><span class='line'>  <span class="n">gem</span> <span class="s1">&#39;capistrano-rails&#39;</span>
</span><span class='line'>  <span class="n">gem</span> <span class="s1">&#39;capistrano-rvm&#39;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h2>初始化</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="err">$</span> <span class="n">cap</span> <span class="n">install</span>
</span></code></pre></td></tr></table></div></figure>


<p>其中有几个比较重要的文件：</p>

<ol>
<li>Capfile用来配置Capistrano</li>
<li>deploy.rb是一些共用task的定义</li>
<li>production.rb / staging.rb用来定义具体的stage的tasks。</li>
</ol>


<p>通过 <code>cap -vT</code> 可以查看当前可用的 task</p>

<h2>配置</h2>

<p><code>capfile</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Load DSL and Setup Up Stages</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;capistrano/setup&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Includes default deployment tasks</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;capistrano/deploy&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 配置支持的插件</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;capistrano/rvm&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;capistrano/bundler&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;capistrano/rails/assets&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;capistrano/rails/migrations&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Loads custom tasks from `lib/capistrano/tasks&#39; if you have any defined.</span>
</span><span class='line'><span class="no">Dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;lib/capistrano/tasks/*.rake&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">r</span><span class="o">|</span> <span class="n">import</span> <span class="n">r</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>deploy.rb</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># config valid only for Capistrano 3.1</span>
</span><span class='line'><span class="n">lock</span> <span class="s1">&#39;3.2.1&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">set</span> <span class="ss">:application</span><span class="p">,</span> <span class="s1">&#39;student_lottery&#39;</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:repo_url</span><span class="p">,</span> <span class="s1">&#39;git@bitbucket.org:linjunzhugg/student_lottery.git&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Default branch is :master</span>
</span><span class='line'><span class="c1"># ask :branch, proc { `git rev-parse --abbrev-ref HEAD`.chomp }.call</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Default deploy_to directory is /var/www/my_app</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:deploy_to</span><span class="p">,</span> <span class="s1">&#39;/home/deploy/student_lottery&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Default value for :scm is :git</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:scm</span><span class="p">,</span> <span class="ss">:git</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Default value for :format is :pretty</span>
</span><span class='line'><span class="c1"># set :format, :pretty</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Default value for :log_level is :debug</span>
</span><span class='line'><span class="c1"># set :log_level, :debug</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Default value for :pty is false</span>
</span><span class='line'><span class="c1"># set :pty, true</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Default value for :linked_files is []</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:linked_files</span><span class="p">,</span> <span class="sx">%w{config/database.yml}</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Default value for linked_dirs is []</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:linked_dirs</span><span class="p">,</span> <span class="sx">%w{bin log tmp/pids tmp/cache tmp/sockets vendor/bundle public/system}</span>
</span><span class='line'>
</span><span class='line'><span class="n">set</span> <span class="ss">:rvm_ruby_version</span><span class="p">,</span> <span class="s1">&#39;ruby-2.0.0-p481@rails4.0.4&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Default value for default_env is {}</span>
</span><span class='line'><span class="c1"># set :default_env, { path: &quot;/opt/ruby/bin:$PATH&quot; }</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Default value for keep_releases is 5</span>
</span><span class='line'><span class="c1"># set :keep_releases, 5</span>
</span><span class='line'>
</span><span class='line'><span class="n">namespace</span> <span class="ss">:deploy</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">desc</span> <span class="s1">&#39;Restart application&#39;</span>
</span><span class='line'>  <span class="n">task</span> <span class="ss">:restart</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">on</span> <span class="n">roles</span><span class="p">(</span><span class="ss">:app</span><span class="p">),</span> <span class="k">in</span><span class="p">:</span> <span class="ss">:sequence</span><span class="p">,</span> <span class="ss">wait</span><span class="p">:</span> <span class="mi">5</span> <span class="k">do</span>
</span><span class='line'>      <span class="c1"># Your restart mechanism here, for example:</span>
</span><span class='line'>      <span class="c1"># execute :touch, release_path.join(&#39;tmp/restart.txt&#39;)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># 就是这里插入的任务</span>
</span><span class='line'>  <span class="n">after</span> <span class="ss">:publishing</span><span class="p">,</span> <span class="ss">:restart</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">after</span> <span class="ss">:restart</span><span class="p">,</span> <span class="ss">:clear_cache</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">on</span> <span class="n">roles</span><span class="p">(</span><span class="ss">:web</span><span class="p">),</span> <span class="k">in</span><span class="p">:</span> <span class="ss">:groups</span><span class="p">,</span> <span class="ss">limit</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="ss">wait</span><span class="p">:</span> <span class="mi">10</span> <span class="k">do</span>
</span><span class='line'>      <span class="c1"># Here we can do anything such as:</span>
</span><span class='line'>      <span class="c1"># within release_path do</span>
</span><span class='line'>      <span class="c1">#   execute :rake, &#39;cache:clear&#39;</span>
</span><span class='line'>      <span class="c1"># end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>config/production.rb</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">set</span> <span class="ss">:branch</span><span class="p">,</span> <span class="s1">&#39;master&#39;</span>
</span><span class='line'><span class="c1"># roles 的存在是方便我们针对某个 role 来执行相应的 task</span>
</span><span class='line'><span class="n">server</span> <span class="s1">&#39;192.168.0.13&#39;</span><span class="p">,</span> <span class="ss">user</span><span class="p">:</span> <span class="s1">&#39;deploy&#39;</span><span class="p">,</span> <span class="ss">roles</span><span class="p">:</span> <span class="sx">%w{app, web}</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:rails_env</span><span class="p">,</span> <span class="ss">:production</span>
</span></code></pre></td></tr></table></div></figure>


<h2>开始部署</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="err">$</span> <span class="n">cap</span> <span class="n">production</span> <span class="n">deploy</span>  <span class="c1"># 开始部署</span>
</span></code></pre></td></tr></table></div></figure>


<p>这时有人疑惑了，咦？这条命令的 task 在哪呢？我要如何定义自己的task 呢？</p>

<p>根据官方文档：一旦运行 <code>cap production deploy</code> ，就默认有以下这些任务：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="ss">deploy</span><span class="p">:</span><span class="n">starting</span>    <span class="o">-</span> <span class="n">start</span> <span class="n">a</span> <span class="n">deployment</span><span class="p">,</span> <span class="n">make</span> <span class="n">sure</span> <span class="n">everything</span> <span class="n">is</span> <span class="n">ready</span>
</span><span class='line'><span class="ss">deploy</span><span class="p">:</span><span class="n">started</span>     <span class="o">-</span> <span class="n">started</span> <span class="n">hook</span> <span class="p">(</span><span class="k">for</span> <span class="n">custom</span> <span class="n">tasks</span><span class="p">)</span>
</span><span class='line'><span class="ss">deploy</span><span class="p">:</span><span class="n">updating</span>    <span class="o">-</span> <span class="n">update</span> <span class="n">server</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">with</span> <span class="n">a</span> <span class="kp">new</span> <span class="n">release</span>
</span><span class='line'><span class="ss">deploy</span><span class="p">:</span><span class="n">updated</span>     <span class="o">-</span> <span class="n">updated</span> <span class="n">hook</span>
</span><span class='line'><span class="ss">deploy</span><span class="p">:</span><span class="n">publishing</span>  <span class="o">-</span> <span class="n">publish</span> <span class="n">the</span> <span class="kp">new</span> <span class="n">release</span>
</span><span class='line'><span class="ss">deploy</span><span class="p">:</span><span class="n">published</span>   <span class="o">-</span> <span class="n">published</span> <span class="n">hook</span>
</span><span class='line'><span class="ss">deploy</span><span class="p">:</span><span class="n">finishing</span>   <span class="o">-</span> <span class="n">finish</span> <span class="n">the</span> <span class="n">deployment</span><span class="p">,</span> <span class="n">clean</span> <span class="n">up</span> <span class="n">everything</span>
</span><span class='line'><span class="ss">deploy</span><span class="p">:</span><span class="n">finished</span>    <span class="o">-</span> <span class="n">finished</span> <span class="n">hook</span>
</span></code></pre></td></tr></table></div></figure>


<p>而我们之前在 <code>capfile</code> 中添加了以下的代码：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># 配置支持的插件</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;capistrano/rvm&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;capistrano/bundler&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;capistrano/rails/assets&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;capistrano/rails/migrations&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>这些会自动在 starting  updating 等任务中插入 before after 任务，例如：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">deploy</span>
</span><span class='line'>  <span class="ss">deploy</span><span class="p">:</span><span class="n">starting</span>
</span><span class='line'>    <span class="o">[</span><span class="n">before</span><span class="o">]</span>
</span><span class='line'>      <span class="ss">deploy</span><span class="p">:</span><span class="n">ensure_stage</span>
</span><span class='line'>      <span class="ss">deploy</span><span class="p">:</span><span class="n">set_shared_assets</span>
</span><span class='line'>    <span class="ss">deploy</span><span class="p">:</span><span class="n">check</span>
</span><span class='line'>  <span class="ss">deploy</span><span class="p">:</span><span class="n">started</span>
</span><span class='line'>  <span class="ss">deploy</span><span class="p">:</span><span class="n">updating</span>
</span><span class='line'>    <span class="ss">git</span><span class="p">:</span><span class="n">create_release</span>
</span><span class='line'>    <span class="ss">deploy</span><span class="p">:</span><span class="ss">symlink</span><span class="p">:</span><span class="n">shared</span>
</span><span class='line'>  <span class="ss">deploy</span><span class="p">:</span><span class="n">updated</span>
</span><span class='line'>    <span class="o">[</span><span class="n">before</span><span class="o">]</span>
</span><span class='line'>      <span class="ss">deploy</span><span class="p">:</span><span class="n">bundle</span>
</span><span class='line'>    <span class="o">[</span><span class="n">after</span><span class="o">]</span>
</span><span class='line'>      <span class="ss">deploy</span><span class="p">:</span><span class="n">migrate</span>
</span><span class='line'>      <span class="ss">deploy</span><span class="p">:</span><span class="n">compile_assets</span>
</span><span class='line'>      <span class="ss">deploy</span><span class="p">:</span><span class="n">normalize_assets</span>
</span><span class='line'>  <span class="ss">deploy</span><span class="p">:</span><span class="n">publishing</span>
</span><span class='line'>    <span class="ss">deploy</span><span class="p">:</span><span class="ss">symlink</span><span class="p">:</span><span class="n">release</span>
</span><span class='line'>  <span class="ss">deploy</span><span class="p">:</span><span class="n">published</span>
</span><span class='line'>  <span class="ss">deploy</span><span class="p">:</span><span class="n">finishing</span>
</span><span class='line'>    <span class="ss">deploy</span><span class="p">:</span><span class="n">cleanup</span>
</span><span class='line'>  <span class="ss">deploy</span><span class="p">:</span><span class="n">finished</span>
</span><span class='line'>    <span class="ss">deploy</span><span class="p">:</span><span class="n">log_revision</span>
</span></code></pre></td></tr></table></div></figure>


<p>从中我们可以看到里面有 bundle   migrate 等任务。</p>

<h2>其他插件</h2>

<p>比如 sidekiq 的自动重启，可以加上 <code>capistrano-sidekiq</code>  gem</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-12-26T14:58:57+08:00" pubdate data-updated="true"></time></div>
	<div class="tags">

</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/12/26/linux-shi-yong-lvm-lai-jin-xing-ying-pan-kuo-rong/">
		
			Linux 使用 LVM 来进行硬盘扩容</a>
	</h2>
	<div class="entry-content">
		<h1>Linux 使用 LVM 进行硬盘扩容</h1>

<h2>前言</h2>

<p>这阵子某个项目的服务器硬盘爆了，导致服务出现了异常，汗，现在用着 Google 和 阿里云 的云服务器，但发现两者都没有直接扩容的功能。所以就买了第二块硬盘，但第二块硬盘以后用满了怎么办？因此需要用到 LVM 来对硬盘进行动态扩容，不过并不能在云服务器的默认硬盘上，需要另外购置一块硬盘。</p>

<h2>什么是 LVM？</h2>

<p>LVM 的全名是 Logical Volumn Manager，逻辑卷轴管理员，</p>

<p>一般来说，我们都会将某个硬盘映射到某个分区/目录，但总会有一天该硬盘会满掉，那怎么办呢？买第二块硬盘再把数据移过去？</p>

<p>LVM 就是为了解决这样的问题，它可以将多个硬盘不断的叠加起来，就像一块硬盘在使用一样。</p>

<p>其中有几个概念： PV VG LV PE</p>

<p>PV 指将硬盘转成 <code>Linux LVM</code> 格式</p>

<p>PE 是 LVM 的最小存储区块。</p>

<p><img src="http://linux.vbird.org/linux_basic/0420quota/pe_vg.gif" alt="" /></p>

<h2>对硬盘进行分区</h2>

<p>先切换到 root 用户</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">sudo</span> <span class="n">su</span> <span class="o">-</span>
</span></code></pre></td></tr></table></div></figure>


<p>查看系统已经识别的硬盘</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="err">$</span> <span class="n">fdisk</span> <span class="o">-</span><span class="n">l</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 显示主要信息，会发现有两块硬盘，sdb 则是我们刚刚购置的硬盘</span>
</span><span class='line'><span class="no">Disk</span> <span class="sr">/dev/s</span><span class="ss">da</span><span class="p">:</span> <span class="mi">10</span><span class="o">.</span><span class="mi">7</span> <span class="no">GB</span><span class="p">,</span> <span class="mi">10737418240</span> <span class="n">bytes</span>
</span><span class='line'><span class="no">Disk</span> <span class="sr">/dev/s</span><span class="ss">db</span><span class="p">:</span> <span class="mi">75</span><span class="o">.</span><span class="mi">2</span> <span class="no">GB</span><span class="p">,</span> <span class="mi">75161927680</span> <span class="n">bytes</span>
</span><span class='line'>
</span><span class='line'><span class="err">$</span> <span class="n">fdisk</span> <span class="sr">/dev/s</span><span class="n">db</span>      <span class="c1"># 对硬盘进行操作</span>
</span><span class='line'>
</span><span class='line'><span class="err">$</span>  <span class="nb">p</span><span class="p">(</span><span class="err">显示分区情况</span><span class="p">)</span>
</span><span class='line'>   <span class="n">n</span><span class="p">(</span><span class="err">新建分区</span><span class="p">)</span>
</span><span class='line'>   <span class="n">e</span><span class="p">(</span><span class="err">创建扩展分区</span><span class="p">)</span>
</span><span class='line'>   <span class="n">n</span> <span class="o">-&gt;</span> <span class="n">l</span><span class="p">(</span><span class="err">创建逻辑分区</span><span class="p">)</span>
</span><span class='line'>   <span class="n">t</span><span class="p">(</span><span class="err">设置磁盘</span><span class="no">Hex</span> <span class="n">code</span><span class="p">)</span><span class="err">——</span><span class="o">&gt;</span><span class="c1">#8e(LinuxLVM)——&gt;#w(保存操作)</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="err">$</span> <span class="n">fdisk</span> <span class="sr">/dev/s</span><span class="n">db</span>
</span><span class='line'><span class="err">$</span> <span class="nb">p</span>
</span><span class='line'>
</span><span class='line'><span class="err">会发现：</span>
</span><span class='line'>
</span><span class='line'>  <span class="no">Device</span> <span class="no">Boot</span>      <span class="no">Start</span>     <span class="no">End</span>      <span class="no">Blocks</span>      <span class="no">Id</span>     <span class="no">System</span>
</span><span class='line'>    <span class="sr">/dev/s</span><span class="n">db1</span>          <span class="mi">1</span>       <span class="mi">2080</span>     <span class="mi">1048288</span><span class="o">+</span>     <span class="mi">5</span>     <span class="no">Extended</span>
</span><span class='line'>    <span class="sr">/dev/s</span><span class="n">db5</span>          <span class="mi">1</span>       <span class="mi">2080</span>     <span class="mi">1048257</span>      <span class="mi">8</span><span class="n">e</span>    <span class="no">Linux</span> <span class="no">LVM</span>
</span></code></pre></td></tr></table></div></figure>


<p>这里的逻辑分区 sdb5 已经成功的成为了 <code>Linux LVM</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="err">$</span> <span class="n">partprobe</span> <span class="p">(</span> <span class="err">让</span> <span class="n">kernel</span> <span class="err">重新读取磁盘分区表，即刻生效）</span>
</span></code></pre></td></tr></table></div></figure>


<h2>安装 LVM</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">lvm2</span>
</span></code></pre></td></tr></table></div></figure>


<h2>创建 PV</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="err">$</span> <span class="n">pvcreate</span> <span class="sr">/dev/s</span><span class="n">db5</span>      <span class="c1"># 将此分区转换成为 PV</span>
</span><span class='line'>
</span><span class='line'><span class="err">$</span> <span class="n">pvs</span>    <span class="c1"># 显示所有 PV 情况</span>
</span><span class='line'>
</span><span class='line'>  <span class="no">PV</span>         <span class="no">VG</span>   <span class="no">Fmt</span>  <span class="no">Attr</span> <span class="no">PSize</span>  <span class="no">PFree</span>
</span><span class='line'>  <span class="sr">/dev/s</span><span class="n">db5</span>       <span class="n">lvm2</span> <span class="n">a</span><span class="o">-</span>   <span class="mi">70</span><span class="o">.</span><span class="mo">00</span><span class="n">g</span> <span class="mi">70</span><span class="o">.</span><span class="mo">00</span><span class="n">g</span>
</span></code></pre></td></tr></table></div></figure>


<p>此时发现还没有一个VG</p>

<h2>创建 VG</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="err">$</span> <span class="n">vgcreate</span> <span class="n">vg_data</span> <span class="sr">/dev/s</span><span class="n">db5</span>     <span class="c1"># 这里的 vg_data 是自定义的</span>
</span><span class='line'>
</span><span class='line'><span class="err">$</span> <span class="n">vgs</span>   <span class="c1"># 显示所有 VG </span>
</span><span class='line'>
</span><span class='line'>  <span class="no">VG</span>      <span class="c1">#PV #LV #SN Attr   VSize  VFree</span>
</span><span class='line'>  <span class="n">vg_data</span>   <span class="mi">1</span>   <span class="mi">0</span>   <span class="mi">0</span> <span class="n">wz</span><span class="o">--</span><span class="n">n</span><span class="o">-</span> <span class="mi">70</span><span class="o">.</span><span class="mo">00</span><span class="n">g</span> <span class="mi">70</span><span class="o">.</span><span class="mo">00</span><span class="n">g</span>
</span><span class='line'>
</span><span class='line'><span class="err">$</span> <span class="n">pvs</span>  <span class="c1"># 显示所有 PV</span>
</span><span class='line'>
</span><span class='line'>  <span class="no">PV</span>         <span class="no">VG</span>      <span class="no">Fmt</span>  <span class="no">Attr</span> <span class="no">PSize</span>  <span class="no">PFree</span>
</span><span class='line'>  <span class="sr">/dev/s</span><span class="n">db5</span>  <span class="n">vg_data</span> <span class="n">lvm2</span> <span class="n">a</span><span class="o">-</span>   <span class="mi">70</span><span class="o">.</span><span class="mo">00</span><span class="n">g</span> <span class="mi">70</span><span class="o">.</span><span class="mo">00</span><span class="n">g</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># 会发现 PV 下有个 VG 了  </span>
</span></code></pre></td></tr></table></div></figure>


<h2>创建 LV</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="err">$</span> <span class="n">lvcreate</span> <span class="o">-</span><span class="n">n</span> <span class="n">lv_data</span> <span class="o">-</span><span class="n">L</span> <span class="mi">69</span><span class="o">.</span><span class="mi">5</span><span class="n">G</span> <span class="n">vg_data</span>  <span class="c1"># 另外的 0.5 G 需要用于其他用途</span>
</span><span class='line'>
</span><span class='line'><span class="err">$</span> <span class="n">lvs</span>  <span class="c1"># 显示所有 LV</span>
</span><span class='line'>
</span><span class='line'><span class="no">LV</span>      <span class="no">VG</span>      <span class="no">Attr</span>   <span class="no">LSize</span>  <span class="no">Origin</span> <span class="no">Snap</span><span class="o">%</span>  <span class="no">Move</span> <span class="no">Log</span> <span class="no">Copy</span><span class="o">%</span>  <span class="no">Convert</span>
</span><span class='line'>  <span class="n">lv_data</span> <span class="n">vg_data</span> <span class="o">-</span><span class="n">wi</span><span class="o">-</span><span class="n">a</span><span class="o">-</span> <span class="mi">69</span><span class="o">.</span><span class="mi">50</span><span class="n">g</span>
</span></code></pre></td></tr></table></div></figure>


<h2>格式化分区</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="err">$</span> <span class="n">mkfs</span><span class="o">.</span><span class="n">ext4</span> <span class="sr">/dev/</span><span class="n">vg_data</span><span class="o">/</span><span class="n">lv_data</span>
</span><span class='line'><span class="err">$</span> <span class="n">fdisk</span> <span class="o">-</span><span class="n">l</span>
</span><span class='line'><span class="err">$</span> <span class="n">mount</span> <span class="sr">/dev/</span><span class="n">vg_data</span><span class="o">/</span><span class="n">lv_data</span> <span class="sr">/mnt/</span>   <span class="c1"># 挂到 mnt 下</span>
</span></code></pre></td></tr></table></div></figure>


<h2>以后如何动态扩容？</h2>

<ol>
<li>用 fdisk 設定新的具有 8e system ID 的 partition</li>
<li>利用 pvcreate 建置 PV</li>
<li>利用 vgextend 將 PV 加入我們的 vg_data</li>
<li>用 lvresize 將新加入的 PV 內的 PE 加入 lv_data 中</li>
<li>透過 resize2fs 將檔案系統的容量確實增加！</li>
</ol>


<h3>实际操作</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="err">$</span> <span class="n">fdisk</span> <span class="sr">/dev/s</span><span class="n">db10</span>   <span class="o">=&gt;</span> <span class="err">其他动作参考上面</span>
</span><span class='line'><span class="err">$</span> <span class="n">partprobe</span>
</span><span class='line'><span class="err">$</span> <span class="n">pvcreate</span> <span class="sr">/dev/s</span><span class="n">db10</span>
</span><span class='line'><span class="err">$</span> <span class="n">vgextend</span> <span class="n">vg_data</span> <span class="sr">/dev/s</span><span class="n">db10</span>
</span><span class='line'><span class="err">$</span> <span class="n">vgdisplay</span> <span class="c1"># 显示 VG 的具体信息，会看到剩余的 PE ，假设为 90个</span>
</span><span class='line'><span class="err">$</span> <span class="n">lvresize</span> <span class="o">-</span><span class="n">l</span> <span class="o">+</span><span class="mi">90</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">vg_data</span><span class="o">/</span><span class="n">lv_data</span>    <span class="c1"># 放大 LV</span>
</span></code></pre></td></tr></table></div></figure>


<p>这时 LVM 扩容了，但是档案系统还显示原先的大小</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">resize2fs</span> <span class="sr">/dev/</span><span class="n">vg_data</span><span class="o">/</span><span class="n">lv_data</span>  <span class="c1"># 完整将 LV 容量扩充到整个 filesystem</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># df /mnt/lvm   # 查看大小</span>
</span></code></pre></td></tr></table></div></figure>


<h2>机子重启后自动挂载</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="vg">$blkid</span> <span class="sr">/dev/</span><span class="n">vg_data</span><span class="o">/</span><span class="n">lv_data</span>  <span class="c1"># 查看该设备的 UUID</span>
</span><span class='line'><span class="err">$</span> <span class="n">vim</span> <span class="sr">/etc/</span><span class="n">fstab</span>   <span class="c1"># 编辑自动挂载的名单</span>
</span><span class='line'>
</span><span class='line'><span class="o">=</span><span class="err">》</span><span class="no">UUID</span><span class="o">=</span><span class="mi">1</span><span class="n">eb099f3</span><span class="o">-</span><span class="mi">5332</span><span class="o">-</span><span class="mi">43</span><span class="n">d7</span><span class="o">-</span><span class="n">a98d</span><span class="o">-</span><span class="mi">6</span><span class="n">c1238572cd5</span> <span class="sr">/home/</span><span class="n">deploy</span><span class="o">/</span><span class="n">red_mansions</span>        <span class="n">ext4</span>    <span class="n">defaults</span> <span class="mi">0</span>   <span class="mi">0</span>
</span><span class='line'>
</span><span class='line'><span class="err">$</span> <span class="n">df</span> <span class="o">-</span><span class="no">TH</span>  <span class="c1"># 查看下所有设备</span>
</span><span class='line'>
</span><span class='line'><span class="no">Filesystem</span>     <span class="no">Type</span>      <span class="no">Size</span>  <span class="no">Used</span> <span class="no">Avail</span> <span class="no">Use</span><span class="o">%</span> <span class="no">Mounted</span> <span class="n">on</span>
</span><span class='line'><span class="sr">/dev/s</span><span class="n">da1</span>      <span class="n">ext4</span>       <span class="mi">11</span><span class="n">G</span>  <span class="mi">2</span><span class="o">.</span><span class="mi">7</span><span class="n">G</span>  <span class="mi">7</span><span class="o">.</span><span class="mi">5</span><span class="n">G</span>  <span class="mi">27</span><span class="o">%</span> <span class="o">/</span>
</span><span class='line'><span class="n">udev</span>           <span class="n">devtmpfs</span>  <span class="mi">2</span><span class="o">.</span><span class="mi">0</span><span class="n">G</span>  <span class="mi">8</span><span class="o">.</span><span class="mi">2</span><span class="n">k</span>  <span class="mi">2</span><span class="o">.</span><span class="mi">0</span><span class="n">G</span>   <span class="mi">1</span><span class="o">%</span> <span class="sr">/dev</span>
</span><span class='line'><span class="sr">tmpfs          tmpfs     389M  242k  388M   1% /</span><span class="n">run</span>
</span><span class='line'><span class="n">none</span>           <span class="n">tmpfs</span>     <span class="mi">5</span><span class="o">.</span><span class="mi">3</span><span class="n">M</span>     <span class="mi">0</span>  <span class="mi">5</span><span class="o">.</span><span class="mi">3</span><span class="n">M</span>   <span class="mi">0</span><span class="o">%</span> <span class="sr">/run/</span><span class="n">lock</span>
</span><span class='line'><span class="n">none</span>           <span class="n">tmpfs</span>     <span class="mi">2</span><span class="o">.</span><span class="mi">0</span><span class="n">G</span>     <span class="mi">0</span>  <span class="mi">2</span><span class="o">.</span><span class="mi">0</span><span class="n">G</span>   <span class="mi">0</span><span class="o">%</span> <span class="sr">/run/s</span><span class="n">hm</span>
</span><span class='line'>
</span><span class='line'><span class="err">$</span>  <span class="n">mount</span> <span class="o">-</span><span class="n">a</span> <span class="c1"># 按照 fstab 文件重新挂载一遍</span>
</span><span class='line'><span class="err">$</span>  <span class="n">df</span> <span class="o">-</span><span class="no">TH</span>
</span><span class='line'>
</span><span class='line'><span class="no">Filesystem</span>                  <span class="no">Type</span>      <span class="no">Size</span>  <span class="no">Used</span> <span class="no">Avail</span> <span class="no">Use</span><span class="o">%</span> <span class="no">Mounted</span> <span class="n">on</span>
</span><span class='line'><span class="sr">/dev/s</span><span class="n">da1</span>                   <span class="n">ext4</span>       <span class="mi">11</span><span class="n">G</span>  <span class="mi">2</span><span class="o">.</span><span class="mi">7</span><span class="n">G</span>  <span class="mi">7</span><span class="o">.</span><span class="mi">5</span><span class="n">G</span>  <span class="mi">27</span><span class="o">%</span> <span class="o">/</span>
</span><span class='line'><span class="n">udev</span>                        <span class="n">devtmpfs</span>  <span class="mi">2</span><span class="o">.</span><span class="mi">0</span><span class="n">G</span>  <span class="mi">8</span><span class="o">.</span><span class="mi">2</span><span class="n">k</span>  <span class="mi">2</span><span class="o">.</span><span class="mi">0</span><span class="n">G</span>   <span class="mi">1</span><span class="o">%</span> <span class="sr">/dev</span>
</span><span class='line'><span class="sr">tmpfs                       tmpfs     389M  242k  388M   1% /</span><span class="n">run</span>
</span><span class='line'><span class="n">none</span>                        <span class="n">tmpfs</span>     <span class="mi">5</span><span class="o">.</span><span class="mi">3</span><span class="n">M</span>     <span class="mi">0</span>  <span class="mi">5</span><span class="o">.</span><span class="mi">3</span><span class="n">M</span>   <span class="mi">0</span><span class="o">%</span> <span class="sr">/run/</span><span class="n">lock</span>
</span><span class='line'><span class="n">none</span>                        <span class="n">tmpfs</span>     <span class="mi">2</span><span class="o">.</span><span class="mi">0</span><span class="n">G</span>     <span class="mi">0</span>  <span class="mi">2</span><span class="o">.</span><span class="mi">0</span><span class="n">G</span>   <span class="mi">0</span><span class="o">%</span> <span class="sr">/run/s</span><span class="n">hm</span>
</span><span class='line'><span class="sr">/dev/m</span><span class="n">apper</span><span class="o">/</span><span class="n">vg_data</span><span class="o">-</span><span class="n">lv_data</span> <span class="n">ext4</span>       <span class="mi">74</span><span class="n">G</span>  <span class="mi">7</span><span class="o">.</span><span class="mi">5</span><span class="n">G</span>   <span class="mi">63</span><span class="n">G</span>  <span class="mi">11</span><span class="o">%</span> <span class="sr">/home/</span><span class="n">deploy</span><span class="o">/</span><span class="n">red_mansions</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 会发现设备已经挂载上去了。</span>
</span></code></pre></td></tr></table></div></figure>


<h2>给 设备 赋予授权</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="err">$</span> <span class="n">chown</span> <span class="o">-</span><span class="n">R</span> <span class="ss">deploy</span><span class="p">:</span><span class="n">deploy</span> <span class="sr">/home/</span><span class="n">deploy</span><span class="o">/</span>  <span class="c1"># 因为默认属于 root 权限</span>
</span></code></pre></td></tr></table></div></figure>


<h2>PS</h2>

<p>如果即将要  LV 化的硬盘原先有数据怎么办？ 需要先将数据移走，LV 化后再移进来。</p>

<h2>参考</h2>

<p><a href="http://linux.vbird.org/linux_basic/0420quota.php#lvm">http://linux.vbird.org/linux_basic/0420quota.php#lvm</a>
<a href="http://www.ichiayi.com/wiki/tech/lvm">http://www.ichiayi.com/wiki/tech/lvm</a>
<a href="http://allen7111382.blog.51cto.com/202304/268562">http://allen7111382.blog.51cto.com/202304/268562</a></p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-12-26T14:56:45+08:00" pubdate data-updated="true"></time></div>
	<div class="tags">

</div>
	
</div>
</article>

<nav id="pagenavi">
    
        
            <a href="/" class="prev">Prev</a>
        
    
    
        <a href="/posts/3" class="next">Next</a>
    
    <div class="center"><a href="/blog/archives">Blog Archives</a></div>
</nav>
</div>
	<footer id="footer" class="inner">Copyright &copy; 2019

    林俊柱

</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->






</body>
</html>